<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.92.2" /><link rel="canonical" type="text/html" href="https://pages.github.com/geoffreymbrown/ab-tag/docs/">
<META NAME="ROBOTS" CONTENT="NOINDEX, NOFOLLOW">


<link rel="shortcut icon" href="../../favicons/favicon.ico" >
<link rel="apple-touch-icon" href="../../favicons/apple-touch-icon-180x180.png" sizes="180x180">
<link rel="icon" type="image/png" href="../../favicons/favicon-16x16.png" sizes="16x16">
<link rel="icon" type="image/png" href="../../favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="../../favicons/android-36x36.png" sizes="36x36">
<link rel="icon" type="image/png" href="../../favicons/android-48x48.png" sizes="48x48">
<link rel="icon" type="image/png" href="../../favicons/android-72x72.png" sizes="72x72">
<link rel="icon" type="image/png" href="../../favicons/android-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="../../favicons/android-144x144.png" sizes="144x144">
<link rel="icon" type="image/png" href="../../favicons/android-192x192.png" sizes="192x192">

<title>Documentation | Sub-gram Tags</title>


  
  <meta name="description" content="">
<meta property="og:title" content="Documentation" />
<meta property="og:description" content="Ultralight data loggers for songbirds" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://pages.github.com/geoffreymbrown/ab-tag/docs/" /><meta property="og:site_name" content="Sub-gram Tags" />

<meta itemprop="name" content="Documentation">
<meta itemprop="description" content="Ultralight data loggers for songbirds"><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Documentation"/>
<meta name="twitter:description" content="Ultralight data loggers for songbirds"/>




<link rel="preload" href="../../scss/main.min.cf1ba784c866dfd22344d2170ede76e077419189fd476599431a2d2175446654.css" as="style">
<link href="../../scss/main.min.cf1ba784c866dfd22344d2170ede76e077419189fd476599431a2d2175446654.css" rel="stylesheet" integrity="">


<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>

<script
  src="https://unpkg.com/lunr@2.3.8/lunr.min.js"
  integrity="sha384-vRQ9bDyE0Wnu+lMfm57BlYLO0/XauFuKpVsZPs7KEDwYKktWi5+Kz3MP8++DFlRY"
  crossorigin="anonymous"></script>


<link rel="stylesheet" type="text/css" href="../../hugo-cite.css" />
<link rel="stylesheet" href="https://unpkg.com/tachyons@4.12.0/css/tachyons.min.css" />
<link rel="stylesheet" href="https://unpkg.com/purecss@2.0.6/build/pure-min.css" integrity="sha384-Uu6IeWbM+gzNVXJcM9XV3SohHtmWE+3VGi496jvgX1jyvDTXfdK+rfZc8C1Aehk5" crossorigin="anonymous">








  </head>
  <body class="td-section">
    <header>
      
<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="../../">
		<span class="navbar-logo"><svg id="Capa_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 338.234 338.234" style="enable-background:new 0 0 338.234 338.234"><g><path d="M289.907 70.398c20.551-11.21 24.203-13.379 24.125-15.549-.018-.487-.257-1.166-1.296-1.639-2.043-.93-4.01-1.481-5.913-2.014-3.904-1.094-7.276-2.039-10.483-5.884-1.515-1.816-3.19-5.116-5.13-8.937-6.14-12.093-15.419-30.368-35.404-35.173C252.483.405 249.124.0 245.819.0c-12.257.0-23.432 5.395-32.315 15.601-9.916 11.393-16.38 27.889-19.213 49.032-3.556 26.537-42.166 76.738-65.234 106.733-7.831 10.182-14.017 18.224-16.415 22.217-8.857 14.743-25.584 34.13-39.025 49.708-15.501 17.967-23.576 27.509-23.246 31.08.065.704.411 1.118.69 1.341.385.308.888.464 1.496.464 4.94.0 21.448-12.124 36.73-24.104-10.402 10.931-23.707 25.778-36.707 40.287-4.024 4.491-7.98 8.905-11.752 13.093-11.723 13.017-18.132 24.048-16.326 28.104.458 1.028 1.393 1.595 2.632 1.595 3.332.0 8.409-4.028 12.082-7.408 6.64-6.111 10.544-8.385 12.035-8.495-.004.455-.375 1.779-2.126 4.342-3.955 5.787-5.545 10.701-4.255 13.145.51.967 1.432 1.5 2.595 1.5 2.449.0 5.959-2.402 9.885-6.758 10.59-11.749 46.677-45.226 64.02-61.312 4.808-4.46 8.038-7.463 8.834-8.244.229-.081 1.017-.245 3.72-.245 2.097.0 4.952.053 8.258.149 5.062.148 11.361.27 18.48.27.003.0.003.0.006.0 3.367.0 6.649-.047 9.865-.133.149 3.07-.095 6.791-1.18 7.6-.1.074-.245.166-.434.287-1.243.796-4.155 2.662-8.612 7.718-1.786 2.026-3.755 4.793-2.997 6.472.273.604.855.964 1.558.964h0c.848.0 1.87-.523 2.875-1.472 7.321-6.906 16.732-10.867 25.82-10.867 1.375.0 2.75.093 4.088.276 6.108.836 7.203 1.308 9.19 2.164.909.392 2.04.878 3.886 1.498.829.277 1.574-.159 1.718-.927.345-1.843-3.449-6.933-6.55-8.136-2.834-1.1-6.013-1.657-9.446-1.657-3.584.0-6.753.585-9.067 1.013-1.058.196-1.987.367-2.558.4-.083-1.309-.042-3.839.009-5.658 13.413-.703 25.416-2.22 36.051-4.577 7.512 4.517 14.442 8.799 15.146 9.566.333.453-.217 2.537-.619 4.059-.499 1.889-1.063 4.029-1.198 6.267-.182 3.016.872 5.597 1.928 6.718.473.502.972.756 1.484.756.355.0 1.521-.152 1.639-2.114.173-2.882 4.284-12.004 7.5-14.99 5.245-4.868 9.782-5.318 16.604-5.062 5.505.206 9.673 1.614 11.676 2.291.863.292 1.257.425 1.594.425h0c.402.0.756-.198.946-.53l.269-.593-.292-.5c-.685-1.175-4.476-5.904-10.507-7.565-3.481-.959-6.728-1.445-9.649-1.445-5.626.0-9.029 1.729-11.514 2.991-1.368.696-2.371 1.23-3.168 1.077-1.156-.226-4.804-2.165-9.259-4.731 13.639-4.382 24.52-10.496 32.798-18.398 41.914-40.009 39.871-88.999 30.776-123.104-2.477-9.288-5.682-16.022-8.021-20.938C278.059 80.821 276.563 77.677 289.907 70.398zM158.867 284z"/></g><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/><g/></svg></span><span class="text-uppercase font-weight-bold">Sub-gram Tags</span>
	</a>
	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="../../background/" ><span>Background</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link active" href="../../docs/" ><i class='fas fa-book'></i><span class="active">Documentation</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				
				
				<a class="nav-link" href="../../talks/" ><i class='fas fa-photo-video'></i><span>Talks</span></a>
			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
				
				
				
				
				
				<a class="nav-link" href="https://github.iu.edu/geobrown/Nanotag-paper" target="_blank" ><i class='fab fa-github'></i><span>GitHub</span></a>
			</li>
			
			
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block">



<input
  type="search"
  class="form-control td-search-input"
  placeholder="&#xf002; Search this site…"
  aria-label="Search this site…"
  autocomplete="off"
  
  data-offline-search-index-json-src="../../offline-search-index.3c9fbb5fe89aa2ae258dffb711ee3ddb.json"
  data-offline-search-base-href="../../"
  data-offline-search-max-results="10"
>

</div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <div class="col-12 col-md-3 col-xl-2 td-sidebar d-print-none">
          </div>
          <div class="d-none d-xl-block col-xl-2 td-toc d-print-none">
          </div>
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="../../docs/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Documentation</h1>






<div class="content">
      
</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-43c2b323c0f13a265608d04add6551fc">1 - BitTag</h1>
    
	<div class="pure-g">
    <div class="pure-u-3-4">
    <p>The BitTag is a novel data logger capable of collecting <em>continuous</em> activity data for 360 days &ndash;
depending upon battery size.  The operational concept is simple &ndash; BitTag contains an accelerometer that
detects movement and, based upon the movement dynamics, determines if the subject animal is active.  Each second BitTag generates a single bit of information &ndash; 1 if the animal is active, 0 if it is it is not.
These bits are aggregated (counted) over a measurement period 1 second to 5 minutes; at the end of each
aggregation period the counts are stored in non-volatile memory.  The choice of aggregation period depends upon the length of the experiment and is constrained by the amount of available storage &ndash; 248 hours for raw data to 8660 hours for 5 minute aggregation. <em>In section ?? we present the design of a new BitTag with external memory capable of storing 8738 hours of data aggregated over 15 seconds.</em></p>
<p>BitTag has been used in a variety of experiments with both captive and free animals including monitoring circadian rhythms, determining changes in activity around migration and egg laying, and when migrating animals fly.</p>
</div>
<div class="pure-u-1-4 pa3">
    <img src="../../images/tagv6.png" alt="">
</div>

</div>
<div class="pure-g">
    <div class="pure-u-2-3">
    <p>The key component in the BitTag is a extremely low energy accelerometer &ndash; the adxl362.   This accelerometer
has special activity detection hardware that samples current acceleration along 3-axes at 6hz.  When an animal is completely
still there is 1g acceleration towards the earth due to gravity.  In activity detection mode, the adxl362 tracks acceleration &ndash; when <em>the change</em> in acceleration is greater than a configured threshold, the device signals the BitTag processor that the animal is active.  When the acceleration remains within a configured range for a configured time, the BitTag signals that the animal is inactive.</p>
<p>The detection algorithm is illustrated to the right.  Consider a tag with two states &ndash; inactive and active.  An inactive tag (a) remains inactive until it experiences acceleration greater than the &ldquo;active threshold&rdquo; (b).  An active tag remains active until it remains within a configured acceleration range for a configured time (d).  Notice that whenever an active tag exceeds the configured threshold, the center of the range moves (c-d).  This tracking hardware is
remarkably low energy (300nA), but very effective at tracking bird activity because flying naturally results in high acceleration changes.</p>
</div>
<div class="pure-u-1-3 pa3">
    <img src="../../images/activity-monitor.png" alt="">
</div>

</div>
<div class="row">
    
    <div class="col-md">
      <p>As an example of the type of data that BitTag collects consider the figure on the right which was created with the BitTag visualization tool btviz.   The data illustrate several days during the migration of a
Robin and clearly illustrates a long flight on November 12 with several shorter flights.  Migration during
this period was confirmed with an attached GPS data logger.  (Figure courtesy of Alex Jahn)</p>
<p>The figure is a screen shot of our visualization tool which enables data exploration by zooming, scrolling, and low-pass filtering. Additional overlay graphs are available to display the tag battery voltage and
temperature.  The former is useful for evaluating the battery discharge rate in long experiments.</p>

    </div>
    
    <div class="col-md">
      <figure>
    <img src="../../docs/bittag/images/robin-migration.png#center" width="500px"/> <figcaption>
            <h4>Robin Migration</h4>
        </figcaption>
</figure>

    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      A common way for behavioral scientists to explore activity data is through an &ldquo;actogram&rdquo;.  The actogram is
organized to display multiple 48-hour periods (two days in a row), with rows beginning on successive days.
Thus every 24-hour period is displayed twice &ndash; first in the left column and then in the right column.  Our
visualization tool provides ways to customize the view including the number of rows, data scalling, and offset from
UTC time.   Another feature, not displayed here, is the ability to overlay the sun angle based upon a specific location or
a simulation model for indoor studies.
    </div>
    
    <div class="col-md">
      <figure>
    <img src="../../docs/architecture/images/actogram.png#center" width="500px"/> <figcaption>
            <h4>BitTag Actogram</h4>
        </figcaption>
</figure>

    </div>
    
</div>
  
<h2 id="tag-infrastructure">Tag Infrastructure</h2>
<div class="pure-g">
    <div class="pure-u-3-4">
    <p>The physical design of tags is just a small part of the system design problem.  To
be useful, the tags require a support &ldquo;ecosystem&rdquo; that enables tag configuration,
battery charging, and data recovery.  This ecosystem includes both software (tag firmware,
configuration software, data processing), and support hardware.  For example, we have
developed a &ldquo;standard&rdquo; hardware base to which tags are attached for configuration and
charging.  Variations in battery chemistry necessitate (small)
hardware differences in the bases &ndash; we use two distinct types of batteries NiMn and LiPo.
Furtunately, these hardware differences are opaque to the system software.</p>
<p>Of course different tags will have
variations in geometry, thus our base architecture includes a 3D printed adapter that
is tag specific. The adjacent image illustrates one such adapter along
with the hand tools used to finish the commercially printed component.  The tags carry
a small array of &ldquo;test points&rdquo; (covered with insulation during flight) through which
all base/tag communication occurs.  The mechanical issues of reliably connecting to
the tags are considerable and are discussed in [link].</p>
<p>It is worth noting that we face a scale problem &ndash; supporting experiments with dozens of tags
is considerably different than configuring and testing single tags.  For example, consider that
our partners need to prepare groups of 20-100 tags for flight simultaneously.  Simply charging the
tag batteries takes many hours (e.g. overnight), thus we have also developed chargers that can
be &ldquo;ganged&rdquo; together and connected by a single USB connection.</p>
<p>The adjacent image
illustrates three such chargers (only one USB connector is used per &lsquo;gang&rsquo;).  These chargers can
be built relatively inexpensively (under $50/each in small quantities).</p>
</div>
<div class="pure-u-1-4 pa3">
    <figure>
    <img src="../../docs/architecture/images/IMG_7529.jpg#center" width="300px"/> <figcaption>
            <h4>Programmer for BitTags</h4>
        </figcaption>
</figure>
<figure>
    <img src="../../docs/architecture/images/plasticbasehardware.jpg#center" width="300px"/> <figcaption>
            <h4>Tagbase Adapter and Tools</h4>
        </figcaption>
</figure>
<figure>
    <img src="../../docs/architecture/images/IMG_7523.jpg#center" width="300px"/> <figcaption>
            <h4>Tag Charger Array</h4>
        </figcaption>
</figure>
</div>

</div>
<h2 id="tag-configuration">Tag Configuration</h2>
<p>The tags that we build are highly configurable.  For example, the BitTags can be configured with various &ldquo;thresholds&rdquo; for
determining when the animal is active, different data aggregation choices (from 1 bit/second to active second counts per 5-minutes),
and complex schedules including hibernation periods.</p>
<div class="row">
    
    <div class="col-md">
      The primary tool that we have developed for configuring tags is the &ldquo;Avian Tag Monitor&rdquo;.  This tool organizes
Tag information as a set of tabs.  The first tab, illustrated on the right, provides information about the specific tag
including its current state, battery voltage, and clock error as well as details about the hardware and software on the tag.<br>
This tab also provides various control actions and provides for data download.
    </div>
    
    <div class="col-md">
      <figure>
    <img src="../../docs/architecture/images/tagmonitor.png#center" width="500px"/> <figcaption>
            <h4>NanoLogger Monitor</h4>
        </figcaption>
</figure>

    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      As mentioned, the tags provide the ability to create complex schedules including start and end times for data collection as well as &ldquo;hibernation periods&rdquo; when data collection should be suspended.
    </div>
    
    <div class="col-md">
      <figure>
    <img src="../../docs/architecture/images/schedule.png#center" width="500px"/> <figcaption>
            <h4>NanoLogger Monitor</h4>
        </figcaption>
</figure>

    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      Modern sensors provide many possible configuration options.  For the BitTag, the accelerometer can be configured with various scales,
sample rates, and thresholds for activity detection.<br>
The Tag Monitor provides access to these configuration options.
    </div>
    
    <div class="col-md">
      <figure>
    <img src="../../docs/architecture/images/sensors.png#center" width="500px"/> <figcaption>
            <h4>NanoLogger Monitor</h4>
        </figcaption>
</figure>

    </div>
    
</div>
  
<p>The Tag Monitor software is highly configurable and is designed so that it can be extended to support additional types of sensors and
data storage strategies.  The specific options shown are automatically customized to the tag being configured.   In addition, we provide support for batch testing and configuration of tags through separate command-line tools.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-237f6e7ed1a201e4a1276dfa78fa97ad">2 - User Guides</h1>
    <div class="lead">Instructions for using and configuring tags</div>
	<p>This section provides the following user guides.</p>

</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-bdc8c90a195e6ee22ca6dd03e7d75488">2.1 - Preparing for Flight</h1>
    <div class="lead">Preparing tags for flight</div>
	<p>Preparing BitTags for flight requires the following steps:</p>
<ol>
<li>Charging &ndash; be prepared to charge each tag for at least 2 days</li>
<li>Configuring &ndash; the data collection protocol including start/end times, hibernation periods, and sensor parameters.</li>
<li>Insulating &ndash; after configuration the test points should be immediately covered with insulating tape</li>
<li>Harness attachment</li>
</ol>
<p>In this guide we discuss 1-3.  <strong>Note</strong> some of the photos were made with earlier versions of the tags and tag bases; however, the principles remain the same.</p>
<h2 id="visual-glossary">Visual Glossary</h2>
<h3 id="bit-tags">Bit Tags</h3>
<div class="row">
    
    <div class="col-md">
      Ultra-low power reusable accelerometer loggers, capable of logging  activity up to a year
    </div>
    
    <div class="col-md">
      <img src="./images/image42.jpg" alt="">
    </div>
    
    <div class="col-md">
      <img src="./images/image37.jpg" alt="">
    </div>
    
</div>
  
<h3 id="charger-bases">Charger Bases</h3>
<div class="row">
    
    <div class="col-md">
      Charges Bit Tag batteries and displays battery charge status.
    </div>
    
    <div class="col-md">
      <img src="./images/image30.jpg" alt="">
    </div>
    
</div>
  
<h3 id="programmer-base">Programmer Base</h3>
<div class="cf">
    <div class="fr w-50">
    <img src="./images/image17.jpg" alt="">
</div>
<p>Allows data transfer between Bit Tags and computer, for configuration
and data downloading
</div>
<h3 id="mini-usb-cable">Mini-USB Cable</h3>
<div class="row">
    
    <div class="col-md">
      Delivers power and data to Bit Tag chargers and programming base.
    </div>
    
    <div class="col-md">
      <img src="./images/image44.jpg" alt="">
    </div>
    
</div>
  
<h3 id="insulating-tape-3mm-kapton">Insulating Tape (3mm Kapton)</h3>
<div class="row">
    
    <div class="col-md">
      Protects Bit Tag contacts from short-circuits.
    </div>
    
    <div class="col-md">
      <img src="./images/image28.jpg" alt="">
    </div>
    
</div>
  
<h3 id="tape-application-sticks-4mm-width">Tape Application Sticks (4mm width)</h3>
<div class="row">
    
    <div class="col-md">
      Flat wooden sticks, commonly used as coffee stirrers. Useful for
applying tape to Bit Tags, and for measuring tape length.
    </div>
    
    <div class="col-md">
      <img src="./images/image23.jpg" alt="">
    </div>
    
</div>
  
<h3 id="harness-material">Harness Material</h3>
<div class="row">
    
    <div class="col-md">
      Elastic sewing thread.  May also be available through dental supply houses.
    </div>
    
    <div class="col-md">
      <img src="./images/image36.jpg" alt="">
    </div>
    
</div>
  
<h3 id="scissors">Scissors</h3>
<div class="row">
    
    <div class="col-md">
      For cutting tape and harness material. The smaller the better.
    </div>
    
    <div class="col-md">
      <img src="./images/image27.jpg" alt="">
    </div>
    
</div>
  
<h3 id="monitor-program">Monitor Program</h3>
<div class="row">
    
    <div class="col-md">
      Configures and downloads data from BitTag
    </div>
    
    <div class="col-md">
      <img src="./images/image40.png" alt="">
    </div>
    
</div>
  
<h3 id="btviz-program">btviz Program</h3>
<div class="row">
    
    <div class="col-md">
      Displays data and generates actograms.
    </div>
    
    <div class="col-md">
      <img src="./images/image7.png" alt="">
    </div>
    
</div>
  
<h2 id="bittags">BitTags</h2>
<hr>
<div class="row">
    
    <div class="col-md">
      <img src="./images/image20.jpg" alt="">
    </div>
    
    <div class="col-md">
      <img src="./images/image21.jpg" alt="">
    </div>
    
</div>
  
<h3 id="specifications">Specifications</h3>
<ul>
<li>
<p>Weight (Without Harness) <strong>0.64g</strong></p>
</li>
<li>
<p>Dimensions <strong>22Lx9Wx6H mm</strong></p>
</li>
<li>
<p>Run Time (Depends on mode, limited by battery size)</p>
<ul>
<li>
<p>Bits Per Second <strong>239 hours (~10 days)</strong></p>
</li>
<li>
<p>Counts per Minute <strong>2395 hours (~100 days)</strong></p>
</li>
<li>
<p>Counts per 4 Minutes <strong>9900 hours (~414 days)</strong></p>
</li>
<li>
<p>Counts per 5 Minutes <strong>8700 hours (~362 days)</strong></p>
</li>
</ul>
</li>
<li>
<p>Battery Capacity <strong>5.5 mAh</strong></p>
</li>
<li>
<p>Average Current Consumption <strong>&lt; 1uA</strong></p>
</li>
<li>
<p>CPU <strong>STM32L432KC</strong></p>
</li>
<li>
<p>Accelerometer <strong>ADXL362</strong></p>
</li>
<li>
<p>Clock Accuracy <strong>±3ppm</strong></p>
</li>
</ul>
<h2 id="pre-flight">Pre-Flight</h2>
<h3 id="1-charge-bit-tags">1. Charge Bit Tags</h3>
<div class="row">
    
    <div class="col-md">
      Plug in Charger Base and ensure it is receiving power. A green light will illuminate on the Charger Base that is plugged in.  All other Charger Bases can then share power from this Charger Base.
    </div>
    
    <div class="col-md">
      <img src="./images/image18.jpg" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      Remove nuts and lid from Charger Base
    </div>
    
    <div class="col-md">
      <img src="./images/image41.jpg" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      Place Bit Tag in the plastic holder, ensuring it seats fully.
    </div>
    
    <div class="col-md">
      <img src="./images/image38.jpg" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      Place lid on base, aligning dots.
    </div>
    
    <div class="col-md">
      <img src="./images/image24.jpg" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      Gently tighten nuts with one finger, to avoid damaging delicate electronics.
    </div>
    
    <div class="col-md">
      <img src="./images/image33.jpg" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      <ul>
<li>Check to make sure BitTag makes contact with charger.</li>
<li>Bit Tags typically take 48-27 hours to charge.</li>
<li>Charging is <strong>Not</strong> complete when the battery indicator turns from red to green.  To fully charge, batteries must be held at their charge voltage for 24-48 hours.</li>
</ul>

    </div>
    
    <div class="col-md">
      <img src="./images/image13.jpg" alt="">
<img src="./images/image12.jpg" alt="">
    </div>
    
</div>
  
<ul>
<li>
<p>Remove Bit Tags when done charging. Unused Bit Tags can store  for 1-2 months before needing to be recharged.</p>
</li>
<li>
<p>To remove, reverse the installation process.</p>
</li>
</ul>
<h3 id="2-configure-bit-tags">2. Configure Bit Tags</h3>
<p><strong>Note: Images in this section need updating for newer software</strong></p>
<div class="row">
    
    <div class="col-md">
      Place Bit Tag in Programmer Base, following the same procedure as installing Bit Tags into chargers.
<strong>Note:</strong> Programmer Base must be plugged into computer before receiving a Bit Tag.
    </div>
    
    <div class="col-md">
      <img src="./images/image38.jpg" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      <ul>
<li>Open the monitor program.</li>
<li>Click &ldquo;Attach&rdquo;</li>
<li>Check that battery voltage is <strong>3.0 volts</strong> or greater. If not, detach and recharge. While still functional, battery voltage below 3.0 volts will result in suboptimal runtimes.</li>
</ul>

    </div>
    
    <div class="col-md">
      <p><img src="./images/image11.png" alt=""></p>
<p><img src="./images/image1.png" alt=""></p>

    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      <ul>
<li>If Bit Tag is in a state other than &ldquo;IDLE&rdquo;, you may need to &ldquo;Stop&rdquo; and then &ldquo;Erase&rdquo; Bit Tag.</li>
</ul>

    </div>
    
    <div class="col-md">
      <img src="./images/image3.png" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      <ul>
<li>Once the tag is in the &ldquo;idle&rdquo; state, run the internal tests (&ldquo;Test&rdquo;) and then synchronize the clock &ldquo;Sync&rdquo;.</li>
<li>If any tests fail, you should not use the tag.</li>
</ul>

    </div>
    
    <div class="col-md">
      <img src="./images/image25.png" alt="">
<img src="./images/image5.png" alt="">
    </div>
    
</div>
  
<p><div class="row">
    
    <div class="col-md">
      <ul>
<li>Click into the &ldquo;Configure&rdquo; tab.</li>
<li>Schedule BitTag Data Collection</li>
</ul>

    </div>
    
    <div class="col-md">
      <img src="./images/image35.png" alt="">
<img src="./images/image6.png" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      <ul>
<li>Select Data Type Log Format based upon experiment requirements
<ol>
<li><strong>Activity Bit Per Second</strong>: Gives second-by-second log of whether or not the animal is active. Highest resolution data. Run Time of around <strong>10 days</strong>.</li>
<li><strong>Activity Bit Count Per Minute</strong>: Records the percentage of each minute the animal was active. Run Time of around <strong>100 days</strong>.</li>
<li><strong>Activity Bit Count Per Four/Five Minutes</strong>: Same as Activity Bit Count Per Minute, but over four or five minute intervals. Lowest resolution, but allows Run
Time of around <strong>365 days</strong>.</li>
</ol>
</li>
</ul>

    </div>
    
    <div class="col-md">
      <img src="./images/image34.png" alt="">
    </div>
    
</div>
  </p>
<div class="row">
    
    <div class="col-md">
      Click &ldquo;Run&rdquo; to save settings and start Bit Tag.
    </div>
    
    <div class="col-md">
      <img src="./images/image19.png" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      Return to the &ldquo;Tag State&rdquo; tab.
Ensure that the Bit Tag is in the &ldquo;CONFIGURED&rdquo; or &ldquo;RUNNING&rdquo; state. If not, check your configuration and click &ldquo;Run&rdquo; again.
    </div>
    
    <div class="col-md">
      <img src="./images/image4.png" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      Click &ldquo;Detach&rdquo; and  remove BitTag from base.
    </div>
    
    <div class="col-md">
      <img src="./images/image2.png" alt="">
    </div>
    
</div>
  
<h3 id="3-insulate-bit-tags">3. Insulate Bit Tags</h3>
<div class="row">
    
    <div class="col-md">
      Cut a short strip of Insulating Tape just long enough to fully cover contacts (about 4mm - or the width of tape application sticks) on the back of Bit Tag.
    </div>
    
    <div class="col-md">
      <img src="./images/image22.jpg" alt="">
<img src="./images/image14.jpg" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      Place tape partially on Tape Application Stick (leaving ~2mm overhang lengthwise)
and gently stick one edge onto Bit Tag
    </div>
    
    <div class="col-md">
      <img src="./images/image43.jpg" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      Press stick firmly onto tape and &ldquo;squeegee&rdquo; out any air bubbles or pockets. Tape should sit flat on surface of Bit Tag.
    </div>
    
    <div class="col-md">
      <img src="./images/image31.jpg" alt="">
    </div>
    
</div>
  
<h3 id="4-build-harnesses">4 Build Harnesses</h3>
<p>See section ???</p>
<div class="row">
    
    <div class="col-md">
      Bit Tags can be attached via harness using the four mounting holes (1mm diameter).
For songbird, the size of the leg-loop harness can be estimated using the function described by Naef-Daenzer (2007, J. Avian Biology, 38: 404-407)
    </div>
    
    <div class="col-md">
      <img src="./images/image29.jpg" alt="">
    </div>
    
</div>
  
<h2 id="post-processing">Post-Processing</h2>
<h3 id="1-recovery">1 Recovery</h3>
<div class="row">
    
    <div class="col-md">
      Remove harnesses and insulating tape, being careful not to contact the Bit Tag with sharp or metallic tools.
The Tape Application Stick can also be used to gently peel up the tape.
    </div>
    
    <div class="col-md">
      <img src="./images/image45.png" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      <ul>
<li>Place Bit Tag into Programmer Base.
<ul>
<li>Note: Ensure Programmer Base is plugged into the computer first.</li>
</ul>
</li>
<li>Open the monitor program and attach.</li>
</ul>

    </div>
    
    <div class="col-md">
      <img src="./images/image11.png" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      Stop the BitTag.
    </div>
    
    <div class="col-md">
      <img src="./images/image26.png" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      <ul>
<li>Save data. <strong>Important:</strong> Save your data as a &ldquo;.txt&rdquo; file.
<ul>
<li><strong>Note: The data length may sometimes show up as zero, even if there is saved data onboard.</strong></li>
</ul>
</li>
<li>Detach the BitTag and remove from base.</li>
</ul>

    </div>
    
    <div class="col-md">
      <img src="./images/image15.png" alt="">
    </div>
    
</div>
  
<h3 id="2-data-visualization">2 Data Visualization</h3>
<p>See Section ???</p>
<div class="row">
    
    <div class="col-md">
      <ul>
<li>
<p>Open btviz</p>
</li>
<li>
<p>To import data click &lsquo;load&rsquo; and select data file (data file should have a .txt extension)</p>
</li>
</ul>

    </div>
    
    <div class="col-md">
      <img src="./images/image8.png" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      If you need to trim your data, enter Start and End times then click &ldquo;Zoom&rdquo;
    </div>
    
    <div class="col-md">
      <img src="./images/image39.png" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      <p>You may also use your mouse to visually select these times:</p>
<ol>
<li>
<p>Double-click on the chart with the Left Mouse Button to set the Start time (One-finger double-click on Mac).</p>
</li>
<li>
<p>Double-click on the chart with the Right Mouse Button to set the End time (Double-click with two fingers, or while holding Control (⌃) on Mac).</p>
</li>
<li>
<p>Click &ldquo;Zoom&rdquo;</p>
</li>
</ol>

    </div>
    
    <div class="col-md">
      <img src="./images/image9.png" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      <p>You may export your data in a variety of formats:</p>
<ul>
<li><strong>PDF/PNG</strong>: Saves the currently displayed figure as an image</li>
<li><strong>CSV</strong>: Saves all data currently visible in the image as a .csv file of data points.</li>
</ul>

    </div>
    
    <div class="col-md">
      <img src="./images/image32.png" alt="">
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      You may also view and save actograms by clicking on the &lsquo;actogram&rsquo; tab at the top.
    </div>
    
    <div class="col-md">
      <img src="./images/image10.png" alt="">
    </div>
    
</div>
  

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-cbde5c44ed26452e711738c55a59bae0">2.2 - Tag Configuration</h1>
    <div class="lead">qtmonitor &ndash; the tag configuration and data download application</div>
	<p>To be usable, data logging tags require software applications to configure them prior to &ldquo;flight&rdquo; and to access any data collected &ldquo;post-flight&rdquo;.  The NanoTag architecture is supported by an extensive software system that includes the base-boards used to charge the tags, a software library to support communication with the tags via a USB connection to the baseboard, and applications including a graphical user interface (GUI) tool &ndash; the NanoTag Monitor &ndash; and a collection of command-line tools for querying and testing tags.
Collectively, these tools support the tags through the build process and through their use in biological expariments.  In this section, we focus on the <em>use</em> of these tools rather than their underlying architecture.</p>
<h2 id="nanotag-monitor">NanoTag Monitor</h2>
<div class="row">
    
    <div class="col-md">
      The primary tool for use by biologists is the NanoTag monitor.   This tool, provides the ability to gather metadata about a tag (for example, it&rsquo;s hardware and firmware revisions), to read and write configurations used in experiments, to synchronize the on-board clock, and to access tag data post-experiment.  The monitor screen, displayed to the right, includes a number of tabs &ndash; &ldquo;Tag State&rdquo;, &ldquo;Configure&rdquo;, and &ldquo;Error Log&rdquo; &ndash; to access
various features.  The &ldquo;Tag State&rdquo; tab includes information about the the tag hardware and software,
the current tag status, and various controls.
    </div>
    
    <div class="col-md">
      <figure align="center">
<img src="../../docs/userguides/qtmon/images/qtmonitor.png" alt="NanoTag Monitor">
<figcaption align="center">Fig. 1  NanoTag Monitor</figcaption>
</figure>

    </div>
    
</div>
  
<h3 id="tag-state-tab">Tag State Tab</h3>
<div class="row">
    
    <div class="col-md">
      The status area of the Tag State tab, provides the current state &ndash; in this case &ldquo;IDLE&rdquo;, the clock error, the current battery voltage, and the status of the tag self-tests (which should be run before deployment).  The
tag clock can be synchronized to the host computer (Sync button).
    </div>
    
    <div class="col-md">
      <figure align="center">
<img src="../../docs/userguides/qtmon/images/status.png" alt="NanoTag Status">
<figcaption align="center">Fig. 2  NanoTag Monitor (Status) </figcaption>
</figure>

    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      <p>Tag Information includes the following</p>
<ul>
<li>Tag Type : The type of tag being accessed.</li>
<li>Board Name : The specific board hardware</li>
<li>Firmware   : Tag firmware (software) version</li>
<li>Flash Size : Amount of storage on the tag</li>
<li>UUID : The processor unique identifier which can be used to uniquely identify a specific tag</li>
<li>Git Repo : The git  repository.  This can be used to retrieve the tag software and hardware sources</li>
<li>Source Path:  The location of the tag software in the repository</li>
<li>GitHash : The hash used to identify the specific repository contents used to build the tag software</li>
<li>Build  Date:  The date when the tag software was built.</li>
</ul>

    </div>
    
    <div class="col-md">
      <figure align="center">
<img src="../../docs/userguides/qtmon/images/tag-info.png" alt="NanoTag Information">
<figcaption align="center">Fig. 3  NanoTag Monitor (Information) </figcaption>
</figure>

    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      The Tag State tab provides two important sets of controls.  A running tag
can be stopped (button disabled in the IDLE state), a stopped tag can be
erased (button disabled), and self-tests can be executed (on an idle tag).
The NanoTag monitor can be Detached from the base (and subsequently Attached).  It is
advisable to Detach the base, or close the NanoTag monitor, prior to unplugging the base and
removing a tag.
    </div>
    
    <div class="col-md">
      <figure align="center">
<img src="../../docs/userguides/qtmon/images/control.png" alt="NanoTag Control">
<figcaption align="center">Fig. 4  NanoTag Monitor (Control) </figcaption>
</figure>

    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      The final control area of the Tag State tab is the Data area.  A tag that has executed and stopped can have its data downloaded by the Data save button.  BitTags have only an internal data log, but some tags may additionally have external data logs stored in an external flash.  The count field gives an indication of the amount of data available for download.
    </div>
    
    <div class="col-md">
      <figure align="center">
<img src="../../docs/userguides/qtmon/images/data-save.png" alt="NanoTag Data">
<figcaption align="center">Fig. 5  NanoTag Monitor (Data Save) </figcaption>
</figure>

    </div>
    
</div>
  
<h3 id="configuration-tab">Configuration Tab</h3>
<div class="row">
    
    <div class="col-md">
      <p>The configuration tab provides several sub-tabs for configuring the data collection schedule (start/end times and
hibernation periods), the data to be logged, and tabs for configuring sensors.   The BitTag has a single sensor &ndash; the adxl362 accelerometer, but other tags may have different or additional sensors.  The specific set of configuration sub-tabs is tag specific.</p>
<p>The schedule for an experiment is determined by the start and stop times and any periods when data
collection should be suspended.  It is important to remember that <strong>all times are UTC</strong>.   By default,
data collection begins immediately and runs until storage or energy are exhausted.  Hibernation periods
are defined by the start and end times &ndash; the BitTag supports two such periods)
Schedule times are limited to hour level precision.</p>

    </div>
    
    <div class="col-md">
      <figure align="center">
<img src="../../docs/userguides/qtmon/images/configure.png" alt="NanoTag Configuration">
<figcaption align="center">Fig. 6  NanoTag Monitor Configuration </figcaption>
</figure>

    </div>
    
</div>
  
<p>The configuration tab has two sets of controls (visible in all sub-tabs).  The current configuration
can be saved to or restored from a file.   This is particularly useful for designing a common configuration
for multiple tags to be used in a single experiment.  A (future) command-line tool will use such a stored configuration to enable rapid configuration of a set of tags.</p>
<p>The current tag configuration can be read.  Finally,
the configuration can be written to the tag &ndash; and consequently data collection begun &ndash; with the <strong>start</strong> button.</p>
<figure align="center">
<img src="../../docs/userguides/qtmon/images/startbutton.png" alt="NanoTag Configuration Controls", width=60%>
<figcaption align="center">Fig. 7  NanoTag Monitor Configuration Controls </figcaption>
</figure>
<h3 id="data-logging-configuration">Data Logging Configuration</h3>
<div class="row">
    
    <div class="col-md">
      <p>The allowable log configurations are tag specific.  For the BitTag, the only configuration control
is the aggregation period.  Activity is measured on a per-second basis and may be stored as a bit-per second,
counts/minute, counts/four minutes, and counts/five minute.  The primary determining factor is the total amount of data that can be stored.  The BitTag can store approximately 15,000 data records in its internal memory.  A record consists of a time stamp, battery voltage, temperature, and some number of aggregation bits. At the highest resolution, the maximum collection period is 10 days while at the lowest resolution the tag can store a full year of data.</p>
<table>
<thead>
<tr>
<th>Resolution</th>
<th>Maximum Collection Period</th>
</tr>
</thead>
<tbody>
<tr>
<td>Bit/second</td>
<td>250 hours</td>
</tr>
<tr>
<td>Count/minute</td>
<td>2500 hours</td>
</tr>
<tr>
<td>Count/four minutes</td>
<td>332 days</td>
</tr>
<tr>
<td>Count/five minutes</td>
<td>364 days</td>
</tr>
</tbody>
</table>

    </div>
    
    <div class="col-md">
      <figure align="center">
<img src="../../docs/userguides/qtmon/images/dataconfig.png" alt="NanoTag Data Configuration">
<figcaption align="center">Fig. 8  NanoTag Data Logging Configuration </figcaption>
</figure>

    </div>
    
</div>
  
<h3 id="sensor-configuration">Sensor Configuration</h3>
<div class="row">
    
    <div class="col-md">
      The BitTag only has a single sensor &ndash; the Adxl362 accelerometer &ndash; and is used only as an activity
detector.  There are a number of parameters that can be configured including the accelerometer
sample rate, range (in units of gravity), and the filter.  In most instances, the default parameters are appropriate.   In addition, the activity detector can be configured by setting the thresholds for
transitions to active (active threshold), inactive (inactive threshold), and the time that a tag
must stay below the inactive threshold to return to the inactive state (inactivity).
    </div>
    
    <div class="col-md">
      <figure align="center">
<img src="../../docs/userguides/qtmon/images/adxlconfig.png" alt="NanoTag Sensor Configuration">
<figcaption align="center">Fig. 9  NanoTag Sensor Configuration </figcaption>
</figure>

    </div>
    
</div>
  
<h3 id="error-log">Error Log</h3>
<div class="row">
    
    <div class="col-md">
      The primary function of the Error Log tag is to provide debugging information.  If errors occur in the monitor software, corresponding logging information is displayed in this tab.  The contents of the error log can be saved to a file.  In addition, the current tag  and monitor configurations can be printed to the log.
    </div>
    
    <div class="col-md">
      <figure align="center">
<img src="../../docs/userguides/qtmon/images/error-log.png" alt="NanoTag Error Log">
<figcaption align="center">Fig. 10  NanoTag Error Log </figcaption>
</figure>

    </div>
    
</div>
  
<h2 id="configuration-files">Configuration Files</h2>
<div class="row">
    
    <div class="col-md">
      The tag configuration can be saved (and restored from) a human-readable (JSON) file.  Notice
that every section of the configuration gui has a corresponding section in the configuration files.
Dates/times are recorded as Unix Epochs (seconds since 1/1/1970).  These can be checked with
an on-line tool such as <a href="https://www.epochconverter.com">Epoch Converter</a>.
    </div>
    
    <div class="col-md">
      <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-javascript" data-lang="javascript"><span style="color:#000;font-weight:bold">{</span>
 <span style="color:#4e9a06">&#34;tag_type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;BITTAG&#34;</span><span style="color:#000;font-weight:bold">,</span>
 <span style="color:#4e9a06">&#34;active_interval&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#4e9a06">&#34;start_epoch&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1606230000</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#4e9a06">&#34;end_epoch&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1606406400</span>
 <span style="color:#000;font-weight:bold">},</span>
 <span style="color:#4e9a06">&#34;hibernate&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
  <span style="color:#000;font-weight:bold">{</span>
   <span style="color:#4e9a06">&#34;start_epoch&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1606233600</span><span style="color:#000;font-weight:bold">,</span>
   <span style="color:#4e9a06">&#34;end_epoch&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1606237200</span>
  <span style="color:#000;font-weight:bold">},</span>
  <span style="color:#000;font-weight:bold">{</span>
   <span style="color:#4e9a06">&#34;start_epoch&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1606244400</span><span style="color:#000;font-weight:bold">,</span>
   <span style="color:#4e9a06">&#34;end_epoch&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">1606248000</span>
  <span style="color:#000;font-weight:bold">}</span>
 <span style="color:#000;font-weight:bold">],</span>
 <span style="color:#4e9a06">&#34;bittag_log&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;BITTAG_BITSPERFIVEMIN&#34;</span><span style="color:#000;font-weight:bold">,</span>
 <span style="color:#4e9a06">&#34;acceltag_log&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;ACCELTAG_UNSPECIFIED&#34;</span><span style="color:#000;font-weight:bold">,</span>
 <span style="color:#4e9a06">&#34;adxl362&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#4e9a06">&#34;range&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;R4G&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#4e9a06">&#34;freq&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;S50&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#4e9a06">&#34;filter&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;AAquarter&#34;</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#4e9a06">&#34;act_thresh_g&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.35</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#4e9a06">&#34;inact_thresh_g&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.35</span><span style="color:#000;font-weight:bold">,</span>
  <span style="color:#4e9a06">&#34;inactive_sec&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">0.5</span>
 <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
    </div>
    
</div>
  

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2d843edbc1fd019edcdebb08720e6b86">2.3 - Loop Harnesses</h1>
    <div class="lead">Loop Leg Harness Construction</div>
	<h1 id="guide-to-building-leg-loop-harness-for-activity-loggers">Guide to Building Leg Loop Harness For Activity Loggers</h1>
<p><em>This material adapted from guide written by Dillon Gaugon</em></p>
<div class="row">
    
    <div class="col-md">
      <p>This guide demonstrates a  method to build a leg loop harness for use on birds.</p>
<p>The following empirical formula, presented in <sup id="fnref:1"><a href="#fn:1" class="footnote-ref" role="doc-noteref">1</a></sup>, provides an effective guide for ornithologists seeking to build
harnesses for data loggers and trackers.</p>
<p>$\texttt{harness span} = 14.16 + 8.34*\texttt{body mass}^{0.437}$</p>
<p>The formula, based upon published data from a variety of species should provide a reasonable starting point for size.</p>
<section class="footnotes" role="doc-endnotes">
<hr>
<ol>
<li id="fn:1" role="doc-endnote">
<p>Naef-Daenzer, Beat. <em>An allometric function to fit leg-loop harnesses to terrestrial birds</em>.  <strong>Journal of Avian Biology</strong>, 38:404-407, 2007.&#160;<a href="#fnref:1" class="footnote-backref" role="doc-backlink">&#x21a9;&#xfe0e;</a></p>
</li>
</ol>
</section>

    </div>
    
    <div class="col-md">
      <figure align="center">
<img src="../../docs/userguides/legharness/images/naef-daenzer.png" alt="Loop Harness" width=60%>
<figcaption align="center">Loop Harness: Naef-Daenzer 2007</figcaption>
</figure>

    </div>
    
</div>
  
<p><em>For application of loggers with animals, an individual with the proper permits and training will need to be found or trained by someone with previous experience.</em></p>
<h2 id="step-1-materials">Step 1: Materials</h2>
<div class="row">
    
    <div class="col-md">
      <ul>
<li>First, you’ll need to gather your materials</li>
<li>Six Thumbtacks</li>
<li>Elastic bead cord 1mm (can be obtained at any arts and crafts store)</li>
<li>Small scissors or a razor blade (needs to be sharp to cut string)</li>
<li>Nail Polish (to glue knots together) or super glue</li>
<li>White paint marker or sharpie (to mark the string)</li>
<li>Ruler</li>
<li>A corkboard</li>
<li>A NanoTag Activity Logger</li>
</ul>

    </div>
    
    <div class="col-md">
      <figure align=center>
<img src="../../docs/userguides/legharness/images/materials.png" alt="Harness Materials" width=70%>
<figcaption align=center>Fig. 1 Loop Harness Materials</figcaption>
</figure>

    </div>
    
</div>
  
<h2 id="step-2--start-building-">Step 2:  Start Building !</h2>
<div class="row">
    
    <div class="col-md">
      <ul>
<li>Begin with a size in mind &ndash; you will not be able to measure until later in the process; however, on Juncos we commonly use 42-44mm.</li>
<li>Put the string through a hole on the opposite side of the battery.</li>
<li>Put string through and leave about double the length of your desired size. So, for 40mm loggers, leave about 80mm.</li>
<li>Make sure that the string does not go over the side with the gold dots! These will face down onto the bird’s back.</li>
</ul>

    </div>
    
    <div class="col-md">
      <figure align=center>
<img src="../../docs/userguides/legharness/images/step2.png" alt="Start Building" width=70%>
<figcaption align=center>Fig. 2  Start Building</figcaption>
</figure>

    </div>
    
</div>
  
<h2 id="step-3-safety-knot-">Step 3: Safety Knot !</h2>
<div class="row">
    
    <div class="col-md">
      <ul>
<li>Tie a knot at the base of the second hole that you will put the string through. Make sure you still leave plenty of string!</li>
<li>Make sure it is set up so that the knot will stay at the base.</li>
<li>To make charging easiest, check that the knot is not on the side with the gold dots!</li>
</ul>

    </div>
    
    <div class="col-md">
      <figure align=center>
<img src="../../docs/userguides/legharness/images/safetyknot.png" alt="Safety Knot" width=70%>
<figcaption align=center>Fig. 3 Safety Knot </figcaption>
</figure>

    </div>
    
</div>
  
<h2 id="step-4-finish-threading-loops-">Step 4: Finish Threading Loops !</h2>
<div class="row">
    
    <div class="col-md">
      Put the string through the rest of the holes so that two loops can be made.
    </div>
    
    <div class="col-md">
      <figure align=center>
<img src="../../docs/userguides/legharness/images/finishloops.png" alt="Finish Loops" width=70%>
<figcaption align=center>Fig. 4  Finish Threading Loops </figcaption>
</figure>

    </div>
    
</div>
  
<h2 id="step-5--measure-your-harness">Step 5:  Measure Your Harness</h2>
<div class="row">
    
    <div class="col-md">
      <ul>
<li>You should have measurements in mind before you start building a harness</li>
<li>However, you will only be able to get an accurate measurement of harness size at this step</li>
<li>Take two thumbtacks and place them so that their distance is your desired size</li>
<li>Place the logger around the two thumbtacks; here it measured below for about 43 mm</li>
<li>It’s important to note that the logger is not holding itself together yet! The untied portion is being held taught to estimate the desired size.</li>
</ul>

    </div>
    
    <div class="col-md">
      <figure align=center>
<img src="../../docs/userguides/legharness/images/measureharness.png" alt="Measure Harness" width=70%>
<figcaption align=center>Fig. 5 Measuring the Harness </figcaption>
</figure>

    </div>
    
</div>
  
<h2 id="step-6--mark-your-string">Step 6:  Mark Your String</h2>
<div class="row">
    
    <div class="col-md">
      <ul>
<li>Holding the harness tight, but not too tight, make a mark on the strings so that a knot may be tied on the base of the left side of the logger.</li>
<li>Again, make sure not to have the string too tight (if the thumbtacks are being pulled off the board, it’s too tight.)</li>
</ul>

    </div>
    
    <div class="col-md">
      <figure align=center>
<img src="../../docs/userguides/legharness/images/marking.png" alt="Marking the Harness" width=70%>
<figcaption align=center>Fig. 6 Marking the Harness</figcaption>
</figure>

    </div>
    
</div>
  
<h2 id="step-7-tying-off">Step 7: Tying Off</h2>
<div class="row">
    
    <div class="col-md">
      <ul>
<li>Use the white marks to line up the knot to the size you had measured (there will be some estimation involved but you can always refer to your tacks).</li>
<li>The knots should be tied so that they will stay at the base of the logger (notice the tape, that will need to be applied over the gold dots after charging)</li>
<li>Make sure to check your size, once you have tightened the knot and cut the extra strings.</li>
</ul>

    </div>
    
    <div class="col-md">
      <figure align=center>
<img src="../../docs/userguides/legharness/images/tyingoff.png" alt="Tying the Harness" width=70%>
<figcaption align=center>Fig. 7 Tying the Harness</figcaption>
</figure>

    </div>
    
</div>
  
<h2 id="step-8-sealing-the-knots">Step 8: Sealing the Knots</h2>
<div class="row">
    
    <div class="col-md">
      <ul>
<li>Apply nail polish to the knots as shown so that the knots will hold.</li>
<li>It will dry and function as glue (it is also optional to use super glue)</li>
<li>Try not to use so much that it gets on the rest of the logger.</li>
</ul>

    </div>
    
    <div class="col-md">
      <figure align=center>
<img src="../../docs/userguides/legharness/images/gluingknots.png" alt="Sealing the Knots" width=70%>
<figcaption align=center>Fig. 8 Sealing the Knots</figcaption>
</figure>

    </div>
    
</div>
  
<h2 id="step-9-admire-your-work">Step 9: Admire Your Work</h2>
<div class="row">
    
    <div class="col-md">
      <ul>
<li>Congratulations! You have finished !</li>
<li>You can refer to your tacks one last time to make sure that your measurements have been accurate.</li>
</ul>

    </div>
    
    <div class="col-md">
      <figure align=center>
<img src="../../docs/userguides/legharness/images/admire.png" alt="Admire Your Work" width=70%>
<figcaption align=center>Fig. 9 Admire Your Work</figcaption>
</figure>

    </div>
    
</div>
  

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0b184f3be75a4c0d99a3d8160ce1f40b">2.4 - Visualization</h1>
    <div class="lead">btviz &ndash; the BitTag data visualization tool</div>
	<p>The BitTag visualization application (btviz) allows exploration of data files created using the BitTag monitor.  The tool provides mechanisms to graphically explore data by &ldquo;zooming&rdquo; in on regions of interest, to visualize the data via actograms, and to generate graphics (png) files from the user defined graphs.  In addition, the data exploration tool supports data aggregation and smoothing.</p>
<h2 id="1-loading">1. Loading</h2>
<p>When the tool is opened, the initial screen provides a single action &ndash; load (Fig. 1)</p>
<figure align="center">
<img src="../../docs/userguides/btviz/images/btviz-start.png" alt="Start Screen" width=60%>
<figcaption align="center">Fig. 1: btviz Start Screen</figcaption>
</figure> 
<p>The load action will open a dialog that filter &lsquo;.txt&rsquo; files &ndash; the files created by the tag monitor tool are all human readable text files.  When a file is opened, the activity data for the full time range are displayed.  (Fig. 2)</p>
<figure align="center">
<img src="../../docs/userguides/btviz/images/open8Atxt.png" alt="Raw Data" width=60%> 
<figcaption> Fig 2: Raw Data</figcaption>
</figure> 
<p>Notice that in this example, there are three distinct regions &ndash; the first and last have minimal activity and the middle has a great deal of activity.  The first and last regions correspond to pre and post experiment &ndash; the tag was active, but not on a bird !  It&rsquo;s easy to demonstrate this by displaying the tag temperature data (Fig. 2).</p>
<p>The data are displayed as &ldquo;percentages&rdquo;.  To understand what this means, consider that the BitTags collect activity data as counts of active seconds in a given collection period (for example, 5 minutes).  The activity percentage in a collection period is computed by dividing the count by the length of the collection period (in seconds).</p>
<figure align="center">
<img src="../../docs/userguides/btviz/images/8Atemperature.png" alt="Temperature" width=60%> 
<figcaption> Fig 3: Temperature</figcaption>
</figure> 
<p>Notice that in the middle period, the temperature is around 38C &ndash; corresponding (roughly) to a Junco&rsquo;s body temperature.  With captive animals, a common issue is the loss of a tag due to harness failure.  If the tag is recovered, the temperature data is important for selecting the valid data periods.  The visualization tool also can display the tag battery voltage &ndash; this is important for understanding battery lifetimes.</p>
<h2 id="2-zooming-and-scrolling">2. Zooming and Scrolling</h2>
<p>At the default scale with a long collection period, it is difficult to see any patterns.  The tool supports &ldquo;zooming&rdquo; and scrolling in the data. Using the mouse buttons/track pad/scroll wheel &ndash; some experimentation my be required to determine how to do this on the various platforms on which the tool runs !  For example, the Fig. 4 shows the data for roughly one week.</p>
<figure align="center">
<img src="../../docs/userguides/btviz/images/zoom8A.png" alt="Zoom and Scroll" width=60%> 
<figcaption> Fig. 4: Zoom and Scroll</figcaption>
</figure> 
<p>To return to the full data screen, use the &ldquo;reset&rdquo; button (Fig. 5)</p>
<figure align="center">
<img src="../../docs/userguides/btviz/images/8A-reset.png" alt="Reset Window" width=60%> 
<figcaption> Fig. 5: Reset to Full View</figcaption>
</figure> 
<p>It is also possible to zoom to a pair of cursors (set with the left, right mouse buttons &ndash; os x ctl + click )  or by setting the desired dates.
(Fig. 6)</p>
<figure align="center">
<img src="../../docs/userguides/btviz/images/8A-cursors.png" alt="Using Cursors" width=60%> 
<figcaption> Fig. 6:  Using Cursors</figcaption>
</figure> 
<h2 id="3-data-smoothing">3. Data Smoothing</h2>
<p>Sometimes it is difficult to discern interesting aspects of the data because there appears to be too much noise.  In this case it may be helpful to <em>smooth</em> the data.  There are two types of smoothing filters implemented by the tool &ndash; moving average and exponential moving average (Fig. 7).</p>
<figure align="center">
<img src="../../docs/userguides/btviz/images/8A-filtering.png" alt="Data Smoothing" width=60%> 
<figcaption> Fig. 7:  Data Smoothing</figcaption>
</figure> 
<h1 id="4-export-figures-and-selected-data">4. Export Figures and Selected Data</h1>
<p>The current graph  can be exported in several ways (Fig. 8):</p>
<ul>
<li>printed</li>
<li>saved as a PDF file</li>
<li>saved as a PNG file</li>
<li>data exported to CSV</li>
</ul>
<figure align="center">
<img src="../../docs/userguides/btviz/images/8A-export.png" alt="Data Export" width=60%> 
<figcaption> Fig. 8  Data/Graph Export</figcaption>
</figure> 
<h1 id="5-actograms">5. Actograms</h1>
<p>In addition to exploring the raw data, the tool provides a means to explore via actograms (Fig. 9)</p>
<figure align="center">
<img src="../../docs/userguides/btviz/images/8A-actogram.png" alt="Actograms" width=60%> 
<figcaption> Fig. 9 Actograms</figcaption>
</figure> 
<p>The actograms can be configured in the following ways</p>
<ul>
<li>start day : first day displayed</li>
<li>days : number of days displayed</li>
<li>single/double (24 or 48 hours)</li>
<li>range as a maximum activity percent (PercentLimit)</li>
<li>time zone (offset from UTC)</li>
<li>title for actogram.</li>
</ul>
<p>In addition, the actogram can display actual (for a given location) or simulated sun elevation. (Fig. 10).</p>
<figure align="center">
<img src="../../docs/userguides/btviz/images/8A-elevation.png" alt="Actograms" width=60%> 
<figcaption> Fig. 10 Sun Elevation</figcaption>
</figure> 
<p>Simulated elevation can be used for captive animals to indicate the periods of light.  Currently,
the model is quite basic consisting of a csv (comma separated data) file containing the
start/stop data/times for periods of light.  All times are UTC.</p>
<pre tabindex="0"><code class="language-csv" data-lang="csv">04/01/2019 11:00:00,04/01/2019 23:59:59
04/02/2019 11:00:00,04/02/2019 23:59:59
04/03/2019 11:00:00,04/03/2019 23:59:59
04/04/2019 11:00:00,04/04/2019 23:59:59
04/05/2019 11:00:00,04/05/2019 23:59:59
</code></pre><p>Finally the actogram can be exported as a PDF or PNG file.</p>
<h1 id="tag-metadata">Tag Metadata</h1>
<p>The data files include information about the experiment configuration including collection periods, activity detection, hardware and software versions, and the final clock error (Tag error).  This information can be important for documenting the experiment.  It can also be read directly from the data file.  (Fig. 11)</p>
<figure align="center">
<img src="../../docs/userguides/btviz/images/8Atag-info.png" alt="Tag Metadata" width=60%> 
<figcaption> Fig. 11 Tag Metadata</figcaption>
</figure> 

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-48e7da1da5609ae5016708ab54e4c4a5">2.5 - Command-Line Tools</h1>
    <div class="lead">Tag configuration, testing, and data downloading using command line tools</div>
	<p>The software library upon which the configuration tool is built makes it easy to create command-line tools.  For example, we make extensive use of a <code>tag-test</code> tool during the tag build process.  This tool sets and checks the internal clock and runs the tag self-test routines.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">~/Research/NanoTag/build$ ./bin/tag-test
Board name: BitTag V5
Build time and date: Nov 22 2020 : 10:29:27
Internal Flash size: 256kb
External Flash size: 0kb
Repo: git@github.iu.edu:geobrown/NanoTag.git
Repo hash: 3bde753
UUID: 20383055324850090051006E
Voltage: 3.04
Initial Clock drift: -0.07
#  Checking RTC (2 second delay)
Clock drift after setting: -0.02
State: IDLE
#  Running test
Test Result: ALL_PASSED
</code></pre></div><p>We have planned, but not yet built, a tool to configure tags from stored configuration files.  This tool will:</p>
<ul>
<li>run the self-test</li>
<li>synchronize the clock</li>
<li>print tag information</li>
<li>configure the tag from a file</li>
</ul>
<p>We have developed a simple command line tool &ndash; <code>tag-dwnld</code> that downloads data from stopped tags.   In addition, we have developed a primitive command line interfaces <code>tag-cli</code> that admits reading the status from, stopping, and erasing tags.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-2f208ae3b183985135fb4232e3accb3e">2.6 - Fabrication</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-a23daa7c5abf83fe13558fd9bad75576">2.6.1 - Tools</h1>
    <div class="lead">Tools and Supplies</div>
	<h1 id="tools-and-supplies">Tools and Supplies</h1>
<p>A variety of tools and supplies are needed to</p>
<ol>
<li>Prepare tags for flight</li>
<li>Assemble tags</li>
<li>Assembly bases and chargers</li>
</ol>
<p>Most users will be concerned only with (1)</p>
<h1 id="preparing-tags-for-flight">Preparing Tags For Flight</h1>
<p>For a guide to preparing tags for flight see [section].  This guide, by Jiawei Chen and Tim Greives, while written for the BitTag, applies to other tags as well.</p>
<p>Assuming that the tags are fully assembled, the only supplies and tools required are</p>
<div class="clearfix">
<img src="../../docs/userguides/fabrication/tools/images/kapton.png#floatright" alt="kapton tape" width=30%>
<p><strong>3mm Kapton (polymide) Tape</strong>:  Kapton tape is widely use for insulation on electronics and holds up well under challenging conditions.  For tag flight preparation, a rectangle 3mm by 4mm is ideal for covering the test points on a tag used by the base and chargers for communication.</p>
</div>
<div class="clearfix">
<img src="../../docs/userguides/fabrication/tools/images/ceramic.png#floatright" alt="ceramic tweezers" width=30%>
<p><strong>Ceramic Tweezers</strong>:  While not strictly necessary, ceramic
tweezers are ideal for manipulating the small rectangles of tape used to insulate the tag test points.  These can be obtained inexpensively from Amazon.</p>
</div>
<div class="clearfix">
<img src="../../docs/userguides/fabrication/tools/images/scissors.png#floatright" alt="scissors" width=30%>
<p><strong>Small Scissors</strong>:  A pair of small, sharp scissors is essential for tag preparation.</p>
</div>
<div class="clearfix">
<img src="../../docs/userguides/fabrication/tools/images/stirrers.png#floatright" alt="coffee stirrers" width=30%>
**Tape Application Sticks** (4mm wooden coffee stirrers)
Wooden coffee stirrers are ideal for smoothing insulating tape while minimizing the potential for damage.
</div>
<div class="clearfix">
<img src="../../docs/userguides/fabrication/tools/images/cord.png#floatright" alt="elastic cord" width=30%>
<p><strong>Harness Material (elastic cord)</strong>  1mm (or smaller)
elastic cord is needed for building harnesses.  See
<a href="../../docs/userguides/legharness">leg harness section</a> for directions.</p>
</div>
<h1 id="assembling-tags">Assembling Tags</h1>
<p>The process of assembling tags includes soldering on batteries and applying insulation.  There are two types of insulation used &ndash; the batteries are covered in 1mil kapton tape and, after soldering, the entire assembly is dipped into a urethane coating.</p>
<div class="clearfix">
<img src="../../docs/userguides/fabrication/tools/images/solderingstation.png#floatright" alt="soldering station" width=30%>
<p><strong>Soldering Station</strong> for the fine level assembly required it essential to use a high quality temperature controlled soldering iron with a fine-pitched tip.  In our lab we use the Hakko FX-951 soldering station with fine conical tips (e.g. 0.2mm T15-IL) for most work</p>
</div>
<div class="clearfix">
<img src="../../docs/userguides/fabrication/tools/images/boommicroscope.png#floatright" alt="soldering station" width=30%>
<p><strong>Boom Microscope</strong>  A microscope is not required for assembling tags, but is definitely helpful.  Ideally, this should be a microscope with zoom capability.</p>
</div>
<div class="clearfix">
<img src="../../docs/userguides/fabrication/tools/images/optivisor.png#floatright" alt="optivisor" width=30%>
<p><strong>Optivisor</strong> An optivisor is essential for the fine work necessary to assemble tags.  Be careful to request the ones with glass lenses !</p>
</div>
<div class="clearfix">
<img src="../../docs/userguides/fabrication/tools/images/solder.png#floatright" alt="solder" width=30%>
<p><strong>Solder</strong> A small diameter (e.g. 0.02 inch), leaded, flux core solder is essential.</p>
</div>
<div class="clearfix">
<img src="../../docs/userguides/fabrication/tools/images/flux.png#floatright" alt="flux" width=30%>
<p><strong>Flux</strong> in pen form is especially useful for soldering small components such as batteries.</p>
</div>
<div class="clearfix">
<img src="../../docs/userguides/fabrication/tools/images/fluxremover.png#floatright" alt="flux remover" width=30%>
<p>** Flux Remover** After soldering, all components should be carefully cleaned with flux remover.</p>
</div>
<div  class="clearfix"><img  src="../../docs/userguides/fabrication/tools/images/cottonswabs.png#floatright"  alt="cotton swabs"  width=30%> 
<p><strong>Cotton Swabs</strong> We use fine cotton swabs for this purpose.</p>
</div>
<div class="clearfix">
<p><strong>Kapton Tape</strong>  Various widths of 1mil kapton tape are required for wrapping batteries (1/4&quot;, 3/8&quot;, 1/2&quot;) depending upon battery diameter.  Ideally the tape should be slightly wider than the battery.</p>
</div>
<div  class="clearfix"><img  src="../../docs/userguides/fabrication/tools/images/maskingtape.png#floatright"  alt="Masking Tape"  width=30%>
<p><strong>Masking Taper</strong>  During the coating process we use 6mm Scotch Masking Tape 233 to protect the contacts from the coating.  This is an automotive paint masking tape that bonds well, removes easily, and is compatible with various solvents.</p>
</div>
<div  class="clearfix"><img  src="../../docs/userguides/fabrication/tools/images/floralwire.png#floatright"  alt="FLoral Wire"  width=15%>
<p><strong>Floral Wire</strong>  We use 24 gauge floral wire to make disposable hangers for the tags for use during the coating process.  This is soft, easily bendable wire.</p>
</div>
<div  class="clearfix"><img  src="../../docs/userguides/fabrication/tools/images/xacto.png#floatright"  alt="xacto knife"  width=30%>
<p><strong>xacto knife</strong> An x-acto #1 is essential for cleaning excess coating material after coating tags.</p>
</div>
<div  class="clearfix"><img  src="../../docs/userguides/fabrication/tools/images/pinvise.png#floatright"  alt="pin vise"  width=30%>
<p><strong>Pin Vise</strong>  A pin vise with 1-1.1 mm drill is needed for cleaning the tag holes after coating</p>
</div>
<div  class="clearfix"><img  src="../../docs/userguides/fabrication/tools/images/dykes.png#floatright"  alt="diagonal cutters"  width=30%>
<p><strong>Diagonal Cutters</strong> A small pair of diagonal cutters is needed for forming the tag hangers for coating.</p>
</div>
<div  class="clearfix"><img  src="images/needlenose.png#floatright"  alt="needle nose pliers"  width=30%>
<p><strong>Needle Nose Pliers</strong>  A small pair of needle nose pliers is needed for forming hangers.</p>
</div>
<div  class="clearfix"><img  src="../../docs/userguides/fabrication/tools/images/coating.png#floatright"  alt="Urethane Coating"  width=20%>
<p><strong>MG 4223</strong> We use MG Chemicals 4223 urethane coating for insulating the tags. This is available in a 55ml bottle. In practice we immerse the tags (with batteries) directly in the coating and hang them to dry.</p>
</div>
<h1 id="assembly-of-bases-and-chargers">Assembly of Bases and Chargers</h1>
<p>The assembly of bases and chargers requires the soldering tools described above (soldering station, microscope, solder, flux, flux remover).  In addition it is helpful to have tools to hold the various boards during assembly.</p>
<div  class="clearfix"><img  src="../../docs/userguides/fabrication/tools/images/magneticfixture.png#floatright"  alt="Magnetic Fixture"  width=30%>
<p><strong>Toolour magnetic fixture tower</strong> Magnetic fixtures such as this are useful for holding boards during soldering</p>
</div>
</div>



    
	
  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-31bc0d9a3f9c6fcad90863cf851f2a50">3 - Tag Architecture</h1>
    
	
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="">
    
	<h1 id="pg-981853e298260e0f639a910ecd0f79ab">3.1 - Hardware Architecture</h1>
    
	
<figure>
    <img src="../../docs/architecture/images/tag-simple.svg#%20center"/> <figcaption>
            <h4>Generic Tag Architecture</h4>
        </figcaption>
</figure>

<p>A high level view of the major components of a generic tag is illustrated above
with optional sub-components indicated by dashed boxes.  Every tag has an interface, a battery, a real-time clock (RTC), and a processor.  In our tags we use the STM32L43x family of processors, which have extremely low-power &ldquo;sleep&rdquo; states, and one of several RTC chips &ndash; the RV-3028, RV-8803, and RV-3032.  These RTC chips have exceptionally
low energy requirements (40-240nA) and high accuracy (3-5ppm), and, for RV-8803 and RV-3032, temperature compensation.</p>
<p>The &ldquo;always on&rdquo; domain includes the core processor, the RTC, and any sensors or flash with sufficiently low quiescent current ($I_q$) to remain powered throughout the tag life. For example, the accelerometer used in BitTags and the LIS2DW12 accelerometer discussed in [custom tags] are both low $I_q$ with quiescent currents of 10nA(50nA), respectively.
Some tags will have external flash and/or sensors with high quiescent current requiring
load switches to disconnect them when idle. Both the LPS27 pressure sensor  and the OPT3002 light sensors used
in the custom tags discussed in the section on customization are high $I_q$ sensors with quiescent currents of 0.9uA (0.5uA), respectively.  Similarly, while most external flash memory has high $I_q$, in our custom tags we use<br>
a unique low $I_q$ flash &ndash; the AT25XE321, which can store 4mB data and operates
over a wide voltage range.</p>
<div class="row">
    
    <div class="col-md">
      <p>As an example, consider the two sides of a BitTag  stores
activity bits/counts for up to 6675 hours (9 months) with a 5.5mAh battery.   The energy performance of this tag is directly due to the ADXL362 accelerometer which has a hardware  state machine for activity detection.  When an &ldquo;active&rdquo; accelerometer observes acceleration below a programmed  threshold for a programmed period, it enters a low energy &ldquo;inactive&rdquo; state  in which it samples acceleration at 6Hz. When an &ldquo;inactive&rdquo; accelerometer detects acceleration above a programmed threshold, it wakes and samples at  a higher rate.   The BitTag firmware wakes the processor whenever the ADXL362 transitions between sleep and awake  states in order to track the active periods.</p>
<p>The major components of a BitTag are the processor (STM32l432), RTC (RV-3028), and accelerometer (ADXL362).</p>

    </div>
    
    <div class="col-md">
      <figure>
    <img src="../../docs/architecture/images/bittag-annotated.png#center"/> <figcaption>
            <h4>Two sides of BitTag</h4>
        </figcaption>
</figure>

    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      <p>The other major component of our hardware architecture is a base board (right) that provides software access to the tags
through an ARM standard &lsquo;&lsquo;serial wire debug&rsquo;&rsquo; (SWD) interface.  The tags are connected to the bases by an array of spring loaded &lsquo;&lsquo;pogo-pins&rsquo;&rsquo; (these contact the  six test points illustrated in the tag photo above) and
are supported by tag-specific 3D printed holders. In addition, our bases provide an external current measurement/voltage source interface to enable accurate dynamic current measurement during firmware development.  The base
hardware utilizes low-leakage analog switches to isolate the tag interface during current measurement.
Finally, our tag bases include a battery charger that supports multiple batteries.</p>
<p>We program and communicate with our tags through the bases using existing open-source tools and libraries such as openocd and st-util. To accommodate these tools, our base firmware emulates the st-link protocol used by ST Microelectronics in their proprietary programmers.</p>

    </div>
    
    <div class="col-md">
      <figure>
    <img src="../../docs/architecture/images/tagbase2.png#center"/> <figcaption>
            <h4>Tag Base</h4>
        </figcaption>
</figure>

    </div>
    
</div>
  

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-1e22d908fe8b723d1a82b7bbe0eff5f2">3.2 - Software Architecture</h1>
    
	<p>The system software for NanoTags consists of firmware (the software running on the tags), a host library supporting communication with tags that are connected through a base, and various host applications utilizing this library including a configuration GUI, and command-line tools for testing and
commissioning tags.  Additionally, we have developed a data analysis tool for BitTags which we will not discuss in this section.</p>
<p>Our goal in developing this system software was to create an architecture that can &ldquo;grow&rdquo; with the addition of new types of tags and the creation of specialized firmware to support specific experiments.   At the heart of our architecture is communication and data
transfer (definition) through Google Protocol Buffers.   The fundamental idea of Protocol Buffers is to provide a language for describing data (messages) and a standard way to encode these data in a binary serial form.   The message (data) definitions then form the interface between communicating systems &ndash; in this case tags and system software.  In practice, protocol buffers provides much more in the form of tools that enable their use with a wide variety of languages including compilation of message definitions into language specific libraries.   Protocol Buffers have efficient support for use in embedded code through the nanopb tools.</p>
<p>The use of protocol buffers greatly simplifies the problem of providing a coherent and extensible interface between tags and hosts.  By compiling from common source &ndash; the message definitions &ndash; all aspects of shared data are kept coordinated.  Further, Protocol Buffers provides a standard way to extend the message definitions without breaking backwards compatability.  Thus, we can add support for new tags by extending the message definitions (for example to support new sensor types), and extend the host tools to utilize these new definitions without &ldquo;breaking&rdquo; support for existing tags.  This is particularly important where tags &ldquo;in flight&rdquo; may be in use for many months.</p>
<h1 id="architecture">Architecture</h1>
<p>We  begin by presenting an abstract model of the
tag &ldquo;life cycle&rdquo; which describes the execution of an arbitrary tag.  This tag lifecycle
will serve to motivate the interface to the host library used by our host
applications; we will demonstrate this library with a simple application
that sets the real-time clock on an arbitrary tag.  We then discuss how the
methods of this host interface library are realized with Protocol Buffer based RPC and finally discuss
the tag firmware.</p>
<h2 id="tag">Tag</h2>

<figure>
    <img src="../../docs/architecture/images/lifecycle.svg#center"/> <figcaption>
            <h4>Tag Lifecycle</h4>
        </figcaption>
</figure>

<p>Consider the life cycle of a tag.
which corresponds directly to the runtime state machine.
Notice that there are three <em>categories</em> of states - <em>Erased</em>, <em>Active</em>, and <em>Completed</em>.  In the <em>Erased</em> states, no data or configuration is stored in non-volatile memory.  The <em>Active</em> states correspond to a tag that is configured or is actively collecting data.  In these states, configuration, and event and data logs are stored in non-volatile memory.   Finally, the <em>Completed</em> states are post-experiment in the sense that data collection has ceased by design, by external command, or through an unrecoverable error (e.g. power brown-out).  In the  <em>Completed</em> states, the event and data logs from the last <em>Active</em> period are preserved in non-volatile memory.</p>
<p>In addition to organization by groups of states, our figure distinguishes between three types of state transitions.   Internal transitions
are shown as <em>dashed</em> arrows, transitions in response to an external command are shown as <em>solid</em> arrows, and the transition after commissioning is shown as a <em>double</em> arrow.</p>
<p>The initial state after commissioning and erasure is <strong>Idle</strong>.  From <strong>Idle</strong> various tag-specific tests can be executed under host control.  When a test is initiated, that tag enters the <strong>Test</strong> state; once the test is completed, the tag returns to the <strong>Idle</strong> state.  Test
results are stored in volatile memory.</p>
<p>An experiment (biological or development) is initiated by the host from <strong>Idle</strong>, by configuring the tag with a <strong>Start(config)</strong> command.  The tag configuration includes stop and end times, hibernation periods (when no data are collected), and, tag-specific parameters for sensors and data collection.</p>
<p>From the <strong>Configured</strong> state the tag enters the <strong>Running</strong> state once the configured start time (Config.start) has been reached.  In <strong>Running</strong> the tag actively collects data;  a tag may <em>hibernate</em> (2) for a configured hibernation period during which all data collection ceases.  The fundamental difference between <strong>Hibernation</strong> and <strong>Running</strong> is that in the former, all sensors are powered down and the tag enters the lowest possible energy (dormant) state while in the
later the tag is either quiescent (waiting for an event) or the
processor is actively running.</p>
<p>Under ordinary conditions, a tag remains active until an end condition is met.  This can be a configured end time, exhaustion of available data storage, or exhaustion of available energy.  In each of these cases, the tag will enter <strong>Finish</strong>.  In
the occurrence of an unplanned (1) event, for example a power brown-out, all of the active states will transition to <strong>Aborted</strong>.</p>
<p>The tag is returned from a completed state to <strong>Idle</strong> via an external <strong>Erase()</strong> command; the intermediate <strong>Reset</strong> manages the erasure of the non-volatile storage.</p>
<h2 id="host">Host</h2>
<p>The host software consists of a code library that provides a procedural interface to a tag, and applications that use this library.  These applications
include a graphical user interface intended to be used by researchers who need to configure tags and download collected data, and command-line applications that can be used to test tags and configure them from stored configuration files.  The host library is written in C++ an provides a
tag object model that allows software to use a procedural interface for tag access.</p>
<div class="row">
    
    <div class="col-md">
      <p>Consider again the state diagram describing the tag &ldquo;lifecycle&rdquo; and notice the state transitions labeled Test(), Start(config), Stop(), and Erase().
These correspond directly to methods of the tag class.</p>
<p>The <strong>Start()</strong> command takes a configuration object as a parameter.  In execution, this
configuration object (a Protocol Buffer message) is transferred to the tag; when the tag evaluates the Start command, it records the configuration and enters the <strong>Configurated</strong> state.  It is possible to abort execution of a tag by issuing a <strong>Stop()</strong> command.<br>
A tag may have its data erased with the <strong>Erase()</strong> command.   Finally, all tags have some built-in test functions.  The test sequence
is initiated with the <strong>Test()</strong> command and test status (including failures) returned as a string with the <strong>GetStatus()</strong> command.</p>

    </div>
    
    <div class="col-md">
      <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++">
<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">Start</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Config</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">config</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">Stop</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">Test</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TestReq</span> <span style="color:#000">test</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">Erase</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">GetStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Status</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">GetConfig</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Config</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">cfg</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">SetRtc</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div>
    </div>
    
</div>
  
<div class="row">
    
    <div class="col-md">
      Because the tag software architecture can support a variety of tag types, it is important that the application support a degree of introspection.  This allows the software to determine the type of the
tag, significant aspects of the tag software that admit tracing
back to the github repository from which the software was built, and
the tag processor&rsquo;s unique identifier (UUID).
    </div>
    
    <div class="col-md">
      <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">struct</span> <span style="color:#000">TagInfo</span> <span style="color:#000;font-weight:bold">{</span>
  <span style="color:#000">TagType</span> <span style="color:#000">tag_type</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">// tag type
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span> <span style="color:#000">board_desc</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// board description
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span> <span style="color:#000">uuid</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">// processor unique id
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">int64</span> <span style="color:#000">intflashsz</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">// internal flash size (bytes)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">int64</span> <span style="color:#000">extflashsz</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">// external flash size (bytes)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// software
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span> <span style="color:#000">firmware</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">// firmware description
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span> <span style="color:#000">gitrepo</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">// git repo
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span> <span style="color:#000">githash</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">// git version hash
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span> <span style="color:#000">source_path</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// path to source in repo
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">string</span> <span style="color:#000">build_time</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// build time
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">};</span>

<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">GetTagInfo</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">TagInfo</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">info</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div>
    </div>
    
</div>
  
<p>Finally, the tag library provides methods for downloading data and state logs.  During execution, the tag records each of the system states that it executes (<strong>Configured</strong>, <strong>Running</strong>, etc.) along with key state information such as the time the state was entered, the amount of data recorded, etc.  This system log is accessed through a method that returns this sequence of recorded states.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">GetSystemLog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">std</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">vector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">State</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">system_log</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The type(s) of data recorded by various tags depends upon the sensors on the tag and the tag configuration. This variation
is handled by returning the protocol buffer acknowledgement message to be decoded by a separate library which converts data messages to human readable form</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"> <span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">GetDataLog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">Ack</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">data_log</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">index</span><span style="color:#000;font-weight:bold">);</span>
</code></pre></div><p>The amount of data returned by a single execution of this method is implementation specific; the <em>index</em> parameter indicates the starting point for the next block of data to be returned.</p>
<p>Finally, the tag library provides methods to connect and disconnect from tags.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">Attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UsbDev</span> <span style="color:#000">usbdev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">UsbDev</span><span style="color:#000;font-weight:bold">());</span>
<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">Detach</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">IsAttached</span><span style="color:#000;font-weight:bold">();</span> 
</code></pre></div><p>From the perspective of host software, a tag appears as a USB device (a base) to which the host software attaches and detaches.  The optional parameters of the <strong>Attach</strong> method allow selecting a specific device.</p>
<h2 id="an-example">An Example</h2>
<div class="row">
    
    <div class="col-md">
      <p>We exploit this interface both for a GUI based
tool that we provide to biologists and for
command-line tools to test and commission tags.
The following example illustrates the simplicity
of this interface for creating custom command-line
tools &ndash; in this case to set and check the RTC
for short term drift.
This is one of the steps performed in the commissioning process
to ensure that the RTC is correctly configured.</p>
<p>The first step is to <em>Attach</em> to the tag (through a base connected by USB).  Once the
tag is attached, its real time clock can be set (based upon the host clock).  In this example, the host sleeps for 2 seconds and then reads the tag status which includes its current RTC value in milliseconds.  Finally, the test program computes the clock drift.   While this may appear a useless exercise, it can detect whether the tag RTC is misconfigured or not running.</p>

    </div>
    
    <div class="col-md">
      <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">main</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">argc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">char</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000">argv</span><span style="color:#000;font-weight:bold">)</span>
<span style="color:#000;font-weight:bold">{</span>
  <span style="color:#204a87;font-weight:bold">using</span> <span style="color:#000">MS</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">milliseconds</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">Tag</span> <span style="color:#000">tag</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000">Status</span> <span style="color:#000">status</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#204a87;font-weight:bold">int64_t</span> <span style="color:#000">millis</span><span style="color:#000;font-weight:bold">;</span>

  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">tag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">Attach</span><span style="color:#000;font-weight:bold">())</span>
  <span style="color:#000;font-weight:bold">{</span>
    <span style="color:#8f5902;font-style:italic">// set the RTC
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#000">tag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">SetRtc</span><span style="color:#000;font-weight:bold">();</span>

    <span style="color:#8f5902;font-style:italic">// sleep 2 seconds
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#000">this_thread</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">sleep_for</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">MS</span><span style="color:#000;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">2000</span><span style="color:#000;font-weight:bold">));</span>

    <span style="color:#8f5902;font-style:italic">// Read the RTC
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#000">tag</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">GetStatus</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">);</span>

    <span style="color:#8f5902;font-style:italic">// Compute drift
</span><span style="color:#8f5902;font-style:italic"></span>
    <span style="color:#204a87;font-weight:bold">auto</span> <span style="color:#000">now</span> <span style="color:#ce5c00;font-weight:bold">=</span>  <span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">system_clock</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">();</span>
    <span style="color:#204a87;font-weight:bold">auto</span> <span style="color:#000">ts</span> <span style="color:#ce5c00;font-weight:bold">=</span>  <span style="color:#000">chrono</span><span style="color:#ce5c00;font-weight:bold">::</span><span style="color:#000">time_point_cast</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">MS</span><span style="color:#ce5c00;font-weight:bold">&gt;</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">now</span><span style="color:#000;font-weight:bold">);</span>
    <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">error</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">status</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">millis</span><span style="color:#000;font-weight:bold">()</span>
          <span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000">ts</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">time_since_epoch</span><span style="color:#000;font-weight:bold">().</span><span style="color:#000">count</span><span style="color:#000;font-weight:bold">())</span><span style="color:#ce5c00;font-weight:bold">/</span><span style="color:#0000cf;font-weight:bold">1000.0</span><span style="color:#000;font-weight:bold">;</span>
    <span style="color:#000">cout</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#4e9a06">&#34;Clock Error: &#34;</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">error</span> <span style="color:#ce5c00;font-weight:bold">&lt;&lt;</span> <span style="color:#000">endl</span><span style="color:#000;font-weight:bold">;</span>
  <span style="color:#000;font-weight:bold">}</span>
<span style="color:#000;font-weight:bold">}</span>
</code></pre></div>
    </div>
    
</div>
  
<h1 id="communication-model">Communication Model</h1>
<p>Recall our basic system model consisting of a tag and an associated base..</p>

<figure>
    <img src="../../docs/architecture/images/genericsystem.svg#center" width="600px"/> 
</figure>

<p>For communication between the base and a tag, we utilize a standard serial interface present in all ARM based processors &ndash;
the SWD (serial wire debug) protocol for communication.  By utilizing this interface, our architecture
can, in principle, support tags built with any ARM Cortex embedded processor.  The
physical host/base communication utilizes the ST Microelectronics stlink protocol over USB.  By leveraging
these existing interfaces, we can exploit off-the-shelf tools to program and debug tags.  For example,
we use openocd, an open source package that supports the stlink protocol, for programming and debugging the
tag firmware.   The only host device driver required is libusb, which is supported on large number of operating
systems including linux, windows, and OS X.</p>
<p>Our system architecture leverages these physical and link-layer protocols (swd/stlink/usb) to support host-tag communication.   Host-tag communication is implemented  with a simple remote procedure call (RPC) protocol that commnicates through the SWD debugger interface with the tag processor and utilizes a feature of Cortex-M3 and Cortex-M4 based processors that supports &ldquo;debug monitor&rdquo; interrupts. The RPC messages are encoded with the Google Protocol Buffers message format.</p>
<p>We support the tag host library described previously with a low-level interface that communicates over USB to the base and through the base over SWD to the tags.  The definition for this interface is:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">Attach</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">UsbDev</span> <span style="color:#000">dev</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">UsbDev</span><span style="color:#000;font-weight:bold">());</span>
<span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">Detach</span><span style="color:#000;font-weight:bold">();</span>
<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">Voltage</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">float</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">voltage</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#204a87;font-weight:bold">bool</span> <span style="color:#000">Rpc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">size_t</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">size</span><span style="color:#000;font-weight:bold">);</span>
<span style="color:#000">size_t</span> <span style="color:#000">MaxPacket</span><span style="color:#000;font-weight:bold">();</span>
</code></pre></div><p>There are methods for attaching/detaching that mirror those in the tag library, a few methods for status information
(<strong>Voltage()</strong>, <strong>MaxPacket()</strong>, and a remote procedure call (<strong>Rpc</strong>) method that uses a private buffer for the exchange.  As we shall see, our Protocol Buffer definitions include two major messages &ndash; <strong>Req</strong> and <strong>Ack</strong> supported by a number of other message types.   Hosts send requests (<strong>Req</strong>) to tags and receive acknowlegements (<strong>Ack</strong>) in return.</p>
<h2 id="protocol-definitions">Protocol Definitions</h2>
<div class="row">
    
    <div class="col-md">
      <p>As discussed above, communication with the tags is implemented through a remote procedure call mechanism encoded with protocol buffers.  The Req(uest) message is defined as illustrated to the right.  A request message  contains on of the various choices.  For example, the current tag state is requested with a request containing an (empty) <strong>get_status</strong> message and the current configuration is requested with an (empty) <strong>get_config</strong> message.  Some request messages are non-empty.  For example, the <strong>start</strong> request is encoded as a <strong>Config</strong> message, which, as we shall see, carries all of the information necessary to configure a tag such as start/stop times, hibernation periods, sensor and data logging configuration.</p>
<p>The current system and data logs can be requested with <strong>log</strong> message.   The <strong>LogReq</strong> message type will be discussed subsequently.</p>
<p>In the protocol buffer languages message <em>fields</em> have unique <em>tags</em> (here,the integers 1-9).  These tags play an important role in encoding and decoding messages.   Furthermore, (sub)-messages can be defined as new types and their contents embedded in other messages.  An important characteristic of the encoding/decoding process for protocol messages is that unknown fields are ignored; the consequence of this is that messages in our application can be extended with new fields to support new types of tags without breaking backwards compatibility with exisitng tags.</p>

    </div>
    
    <div class="col-md">
      <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#204a87;font-weight:bold">message</span> <span style="color:#000">Req</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>  <span style="color:#204a87;font-weight:bold">oneof</span> <span style="color:#000">payload</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#8f5902;font-style:italic">// Information
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#000">Empty</span> <span style="color:#000">get_info</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// static tag information
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Empty</span> <span style="color:#000">get_status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// current tag status
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Empty</span> <span style="color:#000">get_config</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// current tag configuration
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#8f5902;font-style:italic">// control
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#000">Empty</span> <span style="color:#000">erase</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// erase tag (return to Idle)
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Config</span> <span style="color:#000">start</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// configure &amp; start tag
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Empty</span> <span style="color:#000">stop</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">// stop tag
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">TestReq</span> <span style="color:#000">test</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// start test
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">int64</span> <span style="color:#000">set_rtc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// set clock (milliseconds)
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#8f5902;font-style:italic">// logs -- see log message for types
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#000">LogReq</span> <span style="color:#000">log</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>  <span style="color:#000;font-weight:bold">}</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#000;font-weight:bold">}</span><span style="color:#a40000">
</span></code></pre></div>
    </div>
    
</div>
  
<p><div class="row">
    
    <div class="col-md">
      Tag info is returned as a
message with fields matching the
C++ interface described above.
    </div>
    
    <div class="col-md">
      <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">Info</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#000">Info_NOT_DEFINED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#000">MONITOR</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#204a87;font-weight:bold">message</span> <span style="color:#000">TagInfo</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>  <span style="color:#000">TagType</span> <span style="color:#000">tag_type</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// tag type (should match config)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// hardware
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000">board_desc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// board description
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000">uuid</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>       <span style="color:#8f5902;font-style:italic">// processor unique id
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">int64</span> <span style="color:#000">intflashsz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// internal flash size (bytes)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">int64</span> <span style="color:#000">extflashsz</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// external flash size (bytes)
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#8f5902;font-style:italic">// software
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000">firmware</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">// firmware description
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000">gitrepo</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">// git repo
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000">githash</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">// git version hash
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000">source_path</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// path to source in repo
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000">build_time</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">10</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// build time
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span><span style="color:#a40000">
</span></code></pre></div>
    </div>
    
</div>
  
Because of the properties of protocol buffers, the definitions for the <strong>Req</strong> message and <strong>Info</strong> enumerated type can
be extended as needed for additional tag types.   The only requirement is that the additional fields are given new and unique numbers.
These additional fields will be ignored by tags not supporting them.</p>
<div class="row">
    
    <div class="col-md">
      Every <strong>Req</strong> sent to a tag must be acknowledged.  The <strong>Ack</strong>(nowlegemnt) message contains two fields &ndash; an error code and return data of various types.    The data returned in response a <strong>Req</strong> depends both upon the type of the request and the type of the tag.   This is
particular the case for log data.  This example provides a single log data type.  New tags or tag firmware may necessitate adding
additional return types.
    </div>
    
    <div class="col-md">
      <div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#204a87;font-weight:bold">message</span> <span style="color:#000">Ack</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>  <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">Err</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#000">UNSPECIFIED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#000">OK</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#8f5902;font-style:italic">// Host Error
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">EMPTY_RETURN</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// return type unexpected
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">MONITOR</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">// reserved for monitor
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// Tag Error
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">NODATA</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// no data
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">INVAL</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// invalid operand
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">PERM</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// operation not permitted
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">NXIO</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// operation failed
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">NANOPB</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// nanopb error
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000;font-weight:bold">}</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>  <span style="color:#000">Err</span> <span style="color:#000">err</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>  <span style="color:#204a87;font-weight:bold">oneof</span> <span style="color:#000">payload</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#000">TagInfo</span> <span style="color:#000">info</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#000">Config</span> <span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">// configuration return
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Status</span> <span style="color:#000">status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">// current status
</span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">string</span> <span style="color:#000">error_message</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// debugging support
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#8f5902;font-style:italic">// Log types
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#000">StateLog</span> <span style="color:#000">system_log</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>    <span style="color:#000">BitTagLog</span> <span style="color:#000">bittag_data_log</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>     <span style="color:#ce5c00;font-weight:bold">...</span> <span style="color:#000">other</span> <span style="color:#000">data</span> <span style="color:#000">log</span> <span style="color:#000">types</span> <span style="color:#000">added</span> <span style="color:#000">as</span> <span style="color:#000">needed</span> <span style="color:#ce5c00;font-weight:bold">...</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>  <span style="color:#000;font-weight:bold">}</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#000;font-weight:bold">}</span><span style="color:#a40000">
</span></code></pre></div>
    </div>
    
</div>
  
<p>The protocol definitions include a number of specialized messages for carrying data including
tag status, configuration, and data/system log messages.   For example, the tag status message includes the current <em>state</em> (from the tag lifecycle diagram), current RTC value, and various other internal information:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-protobuf" data-lang="protobuf"><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">TagState</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>  <span style="color:#000">STATE_UNSPECIFIED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">;</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>  <span style="color:#000">TEST</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">// self test in progress
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">IDLE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>        <span style="color:#8f5902;font-style:italic">// ready
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">CONFIGURED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>  <span style="color:#8f5902;font-style:italic">// configured
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">RUNNING</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">// actively collecting data
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">HIBERNATING</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// running, but not active
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">ABORTED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">;</span>     <span style="color:#8f5902;font-style:italic">// error, or stop received
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">FINISHED</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">// normal termination
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">sRESET</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#000;font-weight:bold">;</span>      <span style="color:#8f5902;font-style:italic">// reset in progress
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">EXCEPTION</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">9</span><span style="color:#000;font-weight:bold">;</span>   <span style="color:#8f5902;font-style:italic">// unhandled exception
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span><span style="color:#a40000">
</span><span style="color:#a40000">
</span><span style="color:#a40000"></span><span style="color:#204a87;font-weight:bold">message</span> <span style="color:#000">Status</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#a40000">
</span><span style="color:#a40000"></span>  <span style="color:#204a87;font-weight:bold">int64</span> <span style="color:#000">millis</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">;</span>              <span style="color:#8f5902;font-style:italic">// current time in ms
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">TagState</span> <span style="color:#000">state</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">;</span>            <span style="color:#8f5902;font-style:italic">// current state
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#000">TestResult</span> <span style="color:#000">test_status</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">;</span>    <span style="color:#8f5902;font-style:italic">// test result
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#000">internal_data_count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// number of internal data entries
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">int32</span> <span style="color:#000">external_data_count</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">5</span><span style="color:#000;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// number of external data entries
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">voltage</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">6</span><span style="color:#000;font-weight:bold">;</span>             <span style="color:#8f5902;font-style:italic">// system voltage
</span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">float</span> <span style="color:#000">temperature</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">;</span>         <span style="color:#8f5902;font-style:italic">// processor Temperature
</span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span><span style="color:#a40000">
</span></code></pre></div><p>With the creation of new tags, some message types are extended (configuration) and new message types added (data logs).  In general, the protocols for our tags are designed to be extensible in the sense that these changes should be backwards compatible with existing tags.</p>
<h1 id="tag-firmware">Tag Firmware</h1>
<p>The tag firmware, written using the ChibiOS RTOS and using the Nanopb implementation of protocol buffers is organized as two threads.  One that executes the state machine in the lifecycle and the other, which is only created when an external device connects, handles protocol buffer communications with the host.</p>
<p>The state machine organization allows us to isolate the changes necessary to create new tags.  In particular, only the portions of the code related to configuration, data collection, and data logging need to change.  Creating a tag with a new type of sensor requires providing a device driver for the sensor and routines to initialize and query the sensor.  Furthermore, it requires extending the configuration message, mechanisms for storing and retrieving the configuration, and the mechanisms for storing and retrieving data.</p>

</div>



    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-84890e281f54b8febdb49422192e7203">4 - Custom Tags</h1>
    <div class="lead">Designing and programming custom tags</div>
	<h2 id="energy-and-power">Energy and Power</h2>
<p>The dominant issue in developing long-life sub-gram tags is energy.  In the tags we describe,
all of the required energy must be carried in the form of batteries &ndash; we do not consider
energy harvesting because of the additional complexity of power management circuitry, weight for
harvesting devices (e.g. solar cells), and, for solar, the likelihood that a solar cell will frequently be obscured.
Power delivery is a closely related issue; as we will show, many of the small batteries that are suitable
for our tags can deliver limited peak power which necessitates additional load  capacitors to deliver
high peak power for sensing and writing flash.  However, capacitors bring their own set of issues in the form of
leakage currents and board area.
In the following section we consider the energy and power requirements of small tags, techniques for minimizing
energy requirements, our approach to measuring energy and power requirements for real tags, and techniques
for estimating the energy requirements for a planned experiment.  Although much of our discussion is generalizable,
we necessarily focus upon the specific components used in our tags.</p>
<h3 id="energy-sources">Energy Sources</h3>
<p>The primary energy source in our tags are batteries; however, in order to meet the peak
power requirements for writing flash memory and for some types of sensors (e.g. magnetometers),
it is necessary to supplement batteries with capacitors.</p>
<p><strong>Batteries</strong> While there are many possible battery chemistries,
we have restricted our attention to rechargeable cells with voltages greater than 2 volts.  The most obvious choices are Lithium Polymer (Li-Po) and Lithium Manganese (Li-Mn).  The smallest
available Li-Po cells weigh approximately 0.4g and have relatively high peak power delivery (e.g. 10mA),
but they have several significant limitations &ndash; it is difficult to obtain small quantities of well characterized sub-gram Li-Po batteries, the cells are physically fragile, and their peak voltage (4.2\si{\volt})
necessitates additional circuitry for power management.</p>
<p>In contrast, physically robust, well characterized Li-Mn batteries with 3.2V peak voltage are available
in a variety of sizes. Their primary limitation is the high internal impedance ($\Omega$) which severely restricts
peak power. By utilizing Li-Mn batteries, our tags can be configured at different weights depending upon the animal species being studied and the length of the planned experiments. For example, our partners studying
pine siskins and great tits require tags below 0.5g with 3 month lifetimes, which
we achieve utilizing MS518 batteries, while year long
studies with robins have been supported by 0.84g tags utilizing
MS920 batteries.</p>
<h2 id="estimating-energy-and-power">Estimating Energy and Power</h2>
<p>Accurate energy and power estimation for our tags requires active measurement of the various operating modes.  The datasheets for the various devices provide architectural guidance, but are not sufficiently accurate for predicting tag lifetime or for determining peak power requirements.   Furthermore, achieving the lowest energy utilization requires significant firmware tuning.  For example, we minimize the cost of waking up from processor Standby by optimizing the firmware initialization code.    Power measurement is an ongoing part of our software development process &ndash; we frequently iterate on firmware design based upon power measurements. In addition, relatively small configuration errors (for example in processor pin initialization or sensor initialization) can lead to significant &ldquo;current leaks&rdquo;.</p>
<p>The dynamic range of power requirements in our tags is roughly 5 orders of magnitude &ndash; 200nA-10mA &ndash;
and involves peak power events as brief as 50us.   In order to accurately measure power requirements we need a current monitor with high sample rate.   We designed our
tag bases to accept connection to the  X-Nucleo-LPM01A &ndash; a programmable voltage source which can make dynamic power measurements from 100nA to 50mA at
100kHz sample rates with a claimed 2% accuracy.</p>
<div class="pure-g">
    <div class="pure-u-1-3">
    To the right is a screen capture from the X-Nucleo software illustrating the
idle power requirements of a BitTag with rv-3028 RTC.  At this low current level, the
software displays considerable noise.  Nonetheless, the <em>average</em> current (238nA) is accurate &ndash; we have
separately validated the low-current performance with a Keithley 6485 picoameter.
</div>
<div class="pure-u-2-3">
    <img src="images/idle-powerv6.png" alt="">
</div>

</div>
<div class="pure-g">
    <div class="pure-u-1-3">
    The STM32L432 datasheet predicts that a 64 bit flash write takes 80-90 us and
requires 3.4mA (average current).  The adjacent figure illustrates a complete log-write
sequence (two 64 bit writes) from processor wake up to return to standby.  Although the current during
the write pulses (to the extreme right) appears somewhat lower than predicted, the overall behavior is consistent with the datasheet estimate.
Notice also the small current spike that occurs at the transition from Standby to running.  The datasheet predicts a
1.23mA spike for 20us during this transition &ndash; this is at the limit for the 100kHz
sample rate of our measurement board.
</div>
<div class="pure-u-2-3">
    <img src="images/brown7.png" alt="">
</div>

</div>
<p>In estimating peak power requirements, we utilize a feature of the
LPM01A software that integrates current (and energy) over time; for example, the average current
in the illustrated example was 424uA and the total energy was 2.74uJ at 2.5V
and the pair of flash writes required 1uJ energy or 0.4uC charge.   We can compute the load capacitance required to
support these writes for a given voltage drop limit using the equation:
$$ Capacitance\ = \ \frac{q}{V} $$</p>
<p>For a maximum 0.1V drop,  the required load capacitor is then
$$\frac{0.4\mu C}{0.1V}\ = \ 4\mu F $$
In practice, the capacitor size would need to be adjusted to compensate for physical effects such degradation with temperature and DC load.</p>
<h2 id="development-platform">Development Platform</h2>
<p>In order to facilitate the rapid prototyping of new tag designs and the evaluation of candidate sensors, we
created a development platform that combines the interfaces of our base board with the processor and RTC required
for our tags.  In the following figure, this platform is illustrated along with a basic &ldquo;daughter&rdquo; card
and includes an AT25XE321 flash memory and and adapter to support the large variety of sensor evaluation boards
from ST Microelectronics.   In addition, one commercial (top right) and one custom (bottom right) sensor evaluation board are illustrated  supporting LPS27 pressure sensor, and OPT3002 light sensor that we
use in this section.  Most commercial sensors are supported by manufacturer or third party evaluation boards (so-called
breakout boards).  While the platform base required commercial fabrication, the daughter card and OPT3002 breakout boards were
fabricated in house with basic soldering equipment.</p>
<p><img src="images/breakout-boards.jpg" alt=""></p>
<h2 id="custom-tags">Custom Tags</h2>
<p>To demonstrate the use of our system architecture for the development of custom tags, we developed three custom ``tags'' with  an accelerometer (LIS2DW12), a pressure sensor (LPS27), and a light sensor (OPT3002).  These are three of the most
commonly used sensor types for avian behavior studies.</p>
<p>While the BitTag has an accelerometer that has exceptional low-power activity detection, the LIS2DW12 has
sophisticated digital low and high-pass filters that may be more suitable logging other behaviors such as
body position or flight; such behavior detection has been used in several notable experiments.<br>





<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#liechti2013nc"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Felix"><span itemprop="familyName">Liechti</span></span>,&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Willem"><span itemprop="familyName">Witvliet</span></span>
                  <em>&amp; al.</em>,&#32;<span itemprop="datePublished">2013</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Liechti</span>,&#32;
    <meta itemprop="givenName" content="Felix" />
    F.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Witvliet</span>,&#32;
    <meta itemprop="givenName" content="Willem" />
    W.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Weber</span>,&#32;
    <meta itemprop="givenName" content="Roger" />
    R.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bächler</span>,&#32;
    <meta itemprop="givenName" content="Erich" />
    E.</span>
  &#32;
    (<span itemprop="datePublished">2013</span>).
  &#32;<span itemprop="name">First evidence of a 200-day non-stop flight in a bird</span>.<i>
    <span itemprop="about">Nature Communications</span>,&#32;4(1)</i>.&#32;<span itemprop="pagination">2554–2554</span>.
  <a href="https://doi.org/10.1038/ncomms3554"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1038/ncomms3554</a></span>




</span></span>)</span>
 , 




<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#liechti2018me"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Felix"><span itemprop="familyName">Liechti</span></span>,&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Silke"><span itemprop="familyName">Bauer</span></span>
                  <em>&amp; al.</em>,&#32;<span itemprop="datePublished">2018</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Liechti</span>,&#32;
    <meta itemprop="givenName" content="Felix" />
    F.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bauer</span>,&#32;
    <meta itemprop="givenName" content="Silke" />
    S.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Dhanjal-Adams</span>,&#32;
    <meta itemprop="givenName" content="Kiran L." />
    K.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Emmenegger</span>,&#32;
    <meta itemprop="givenName" content="Tamara" />
    T.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Zehtindjiev</span>,&#32;
    <meta itemprop="givenName" content="Pavel" />
    P.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hahn</span>,&#32;
    <meta itemprop="givenName" content="Steffen" />
    S.</span>
  &#32;
    (<span itemprop="datePublished">2018</span>).
  &#32;<span itemprop="name">Miniaturized multi-sensor loggers provide new insight into year-round flight behaviour of small trans-Sahara avian migrants</span>.<i>
    <span itemprop="about">Movement Ecology</span>,&#32;6(1)</i>.&#32;<span itemprop="pagination">19–19</span>.
  <a href="https://doi.org/10.1186/s40462-018-0137-1"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1186/s40462-018-0137-1</a></span>




</span></span>)</span>
, 




<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#hedenstrom2016cb"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Anders"><span itemprop="familyName">Hedenström</span></span>,&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Gabriel"><span itemprop="familyName">Norevik</span></span>
                  <em>&amp; al.</em>,&#32;<span itemprop="datePublished">2016</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hedenström</span>,&#32;
    <meta itemprop="givenName" content="Anders" />
    A.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Norevik</span>,&#32;
    <meta itemprop="givenName" content="Gabriel" />
    G.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Warfvinge</span>,&#32;
    <meta itemprop="givenName" content="Kajsa" />
    K.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Andersson</span>,&#32;
    <meta itemprop="givenName" content="Arne" />
    A.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bäckman</span>,&#32;
    <meta itemprop="givenName" content="Johan" />
    J.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Åkesson</span>,&#32;
    <meta itemprop="givenName" content="Susanne" />
    S.</span>
  &#32;
    (<span itemprop="datePublished">2016</span>).
  &#32;<span itemprop="name">Annual 10-Month Aerial Life Phase in the Common Swift Apus apus</span>.<i>
    <span itemprop="about">Current Biology</span>,&#32;26(22)</i>.&#32;<span itemprop="pagination">3066–3070</span>.
  <a href="https://doi.org/10.1016/j.cub.2016.09.014"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1016/j.cub.2016.09.014</a></span>




</span></span>)</span>
  A commonly used measurement to detect flight modes
and estimate energy expenditure is the ``vectorial dynamic acceleration'' (VeDBA).





<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#stothart2016jeb"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Mason R."><span itemprop="familyName">Stothart</span></span>,&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Kyle H."><span itemprop="familyName">Elliott</span></span>
                  <em>&amp; al.</em>,&#32;<span itemprop="datePublished">2016</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Stothart</span>,&#32;
    <meta itemprop="givenName" content="Mason R." />
    M.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Elliott</span>,&#32;
    <meta itemprop="givenName" content="Kyle H." />
    K.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Wood</span>,&#32;
    <meta itemprop="givenName" content="Thomas" />
    T.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hatch</span>,&#32;
    <meta itemprop="givenName" content="Scott A." />
    S.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Speakman</span>,&#32;
    <meta itemprop="givenName" content="John R." />
    J.</span>
  &#32;
    (<span itemprop="datePublished">2016</span>).
  &#32;<span itemprop="name">Counting calories in cormorants: dynamic body acceleration predicts daily energy expenditure measured in pelagic cormorants</span>.<i>
    <span itemprop="about">Journal of Experimental Biology</span></i>.&#32;<span itemprop="pagination">jeb.130526</span>.
  <a href="https://doi.org/10.1242/jeb.130526"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1242/jeb.130526</a></span>




</span></span>)</span>
 , 




<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#williams2015ab"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="H. J."><span itemprop="familyName">Williams</span></span>,&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="E. L.C. C"><span itemprop="familyName">Shepard</span></span>
                  <em>&amp; al.</em>,&#32;<span itemprop="datePublished">2015</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Williams</span>,&#32;
    <meta itemprop="givenName" content="H. J." />
    H.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Shepard</span>,&#32;
    <meta itemprop="givenName" content="E. L.C. C" />
    E.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Duriez</span>,&#32;
    <meta itemprop="givenName" content="O." />
    O.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Lambertucci</span>,&#32;
    <meta itemprop="givenName" content="S. A." />
    S.</span>
  &#32;
    (<span itemprop="datePublished">2015</span>).
  &#32;<span itemprop="name">Can accelerometry be used to distinguish between flight types in soaring birds?</span>.<i>
    <span itemprop="about">Animal Biotelemetry</span>,&#32;3(1)</i>.&#32;<span itemprop="pagination">45–45</span>.
  <a href="https://doi.org/10.1186/s40317-015-0077-0"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1186/s40317-015-0077-0</a></span>




</span></span>)</span>
, 




<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#spivey2013jotrsi"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="R. J."><span itemprop="familyName">Spivey</span></span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="C. M."><span itemprop="familyName">Bishop</span></span>,&#32;<span itemprop="datePublished">2013</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Spivey</span>,&#32;
    <meta itemprop="givenName" content="R. J." />
    R.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bishop</span>,&#32;
    <meta itemprop="givenName" content="C. M." />
    C.</span>
  &#32;
    (<span itemprop="datePublished">2013</span>).
  &#32;<span itemprop="name">Interpretation of body-mounted accelerometry in flying animals and estimation of biomechanical power</span>.<i>
    <span itemprop="about">Journal of The Royal Society Interface</span>,&#32;10(87)</i>.&#32;<span itemprop="pagination">20130404</span>.
  <a href="https://doi.org/10.1098/rsif.2013.0404"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1098/rsif.2013.0404</a></span>




</span></span>)</span>
, 




<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#gleiss2011mee"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Adrian C."><span itemprop="familyName">Gleiss</span></span>,&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Rory P."><span itemprop="familyName">Wilson</span></span>
                  <em>&amp; al.</em>,&#32;<span itemprop="datePublished">2011</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Gleiss</span>,&#32;
    <meta itemprop="givenName" content="Adrian C." />
    A.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Wilson</span>,&#32;
    <meta itemprop="givenName" content="Rory P." />
    R.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Shepard</span>,&#32;
    <meta itemprop="givenName" content="Emily L. C." />
    E.</span>
  &#32;
    (<span itemprop="datePublished">2011</span>).
  &#32;<span itemprop="name">Making overall dynamic body acceleration work: on the theory of acceleration as a proxy for energy expenditure</span>.<i>
    <span itemprop="about">Methods in Ecology and Evolution</span>,&#32;2(1)</i>.&#32;<span itemprop="pagination">23–33</span>.
  <a href="https://doi.org/https://doi.org/10.1111/j.2041-210X.2010.00057.x"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/https://doi.org/10.1111/j.2041-210X.2010.00057.x</a></span>




</span></span>)</span>

VeDBA is the magnitude of the high-pass filtered acceleration vector.  The low-pass filtered acceleration
vector can be used to accurately compute the pitch and roll angles for an accelerometer tag.</p>
<p>Pressure sensors have been shown to have great utility in understanding the behavior of
birds during migration.  For example, 




<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#dhanjal-adams2018cb"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Kiran L."><span itemprop="familyName">Dhanjal-Adams</span></span>,&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Silke"><span itemprop="familyName">Bauer</span></span>
                  <em>&amp; al.</em>,&#32;<span itemprop="datePublished">2018</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Dhanjal-Adams</span>,&#32;
    <meta itemprop="givenName" content="Kiran L." />
    K.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bauer</span>,&#32;
    <meta itemprop="givenName" content="Silke" />
    S.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Emmenegger</span>,&#32;
    <meta itemprop="givenName" content="Tamara" />
    T.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hahn</span>,&#32;
    <meta itemprop="givenName" content="Steffen" />
    S.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Lisovski</span>,&#32;
    <meta itemprop="givenName" content="Simeon" />
    S.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Liechti</span>,&#32;
    <meta itemprop="givenName" content="Felix" />
    F.</span>
  &#32;
    (<span itemprop="datePublished">2018</span>).
  &#32;<span itemprop="name">Spatiotemporal Group Dynamics in a Long-Distance Migratory Bird</span>.<i>
    <span itemprop="about">Current Biology</span>,&#32;28(17)</i>.&#32;<span itemprop="pagination">2824–2830.e3</span>.
  <a href="https://doi.org/10.1016/j.cub.2018.06.054"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1016/j.cub.2018.06.054</a></span>




</span></span>)</span>
 demonstrated that by comparing pressure measurements over time it is feasible to determine which animals from a given site migrate together, 




<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#liechti2018me"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Felix"><span itemprop="familyName">Liechti</span></span>,&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Silke"><span itemprop="familyName">Bauer</span></span>
                  <em>&amp; al.</em>,&#32;<span itemprop="datePublished">2018</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Liechti</span>,&#32;
    <meta itemprop="givenName" content="Felix" />
    F.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bauer</span>,&#32;
    <meta itemprop="givenName" content="Silke" />
    S.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Dhanjal-Adams</span>,&#32;
    <meta itemprop="givenName" content="Kiran L." />
    K.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Emmenegger</span>,&#32;
    <meta itemprop="givenName" content="Tamara" />
    T.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Zehtindjiev</span>,&#32;
    <meta itemprop="givenName" content="Pavel" />
    P.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hahn</span>,&#32;
    <meta itemprop="givenName" content="Steffen" />
    S.</span>
  &#32;
    (<span itemprop="datePublished">2018</span>).
  &#32;<span itemprop="name">Miniaturized multi-sensor loggers provide new insight into year-round flight behaviour of small trans-Sahara avian migrants</span>.<i>
    <span itemprop="about">Movement Ecology</span>,&#32;6(1)</i>.&#32;<span itemprop="pagination">19–19</span>.
  <a href="https://doi.org/10.1186/s40462-018-0137-1"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1186/s40462-018-0137-1</a></span>




</span></span>)</span>
 demonstrated that one can reliably use pressure measurements to determine when animals are migrating, and 




<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#sjoberg2021sa"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Sissel"><span itemprop="familyName">Sjöberg</span></span>,&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Gintaras"><span itemprop="familyName">Malmiga</span></span>
                  <em>&amp; al.</em>,&#32;<span itemprop="datePublished">2021</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Sjöberg</span>,&#32;
    <meta itemprop="givenName" content="Sissel" />
    S.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Malmiga</span>,&#32;
    <meta itemprop="givenName" content="Gintaras" />
    G.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Nord</span>,&#32;
    <meta itemprop="givenName" content="Andreas" />
    A.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Andersson</span>,&#32;
    <meta itemprop="givenName" content="Arne" />
    A.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bäckman</span>,&#32;
    <meta itemprop="givenName" content="Johan" />
    J.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Tarka</span>,&#32;
    <meta itemprop="givenName" content="Maja" />
    M.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Willemoes</span>,&#32;
    <meta itemprop="givenName" content="Mikkel" />
    M.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Thorup</span>,&#32;
    <meta itemprop="givenName" content="Kasper" />
    K.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hansson</span>,&#32;
    <meta itemprop="givenName" content="Bengt" />
    B.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Alerstam</span>,&#32;
    <meta itemprop="givenName" content="Thomas" />
    T.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hasselquist</span>,&#32;
    <meta itemprop="givenName" content="Dennis" />
    D.</span>
  &#32;
    (<span itemprop="datePublished">2021</span>).
  &#32;<span itemprop="name">Extreme altitudes during diurnal flights in a nocturnal songbird migrant</span>.<i>
    <span itemprop="about">Science</span>,&#32;372(6542)</i>.&#32;<span itemprop="pagination">646–648</span>.
  <a href="https://doi.org/10.1126/science.abe7291"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1126/science.abe7291</a></span>




</span></span>)</span>
 determined that small animals may fly above 5000 meters during migration.   A sub-gram pressure tag has previously been developed, but  with significantly less storage and greater energy requirements than the one presented in this paper. \cite{shipley2018mee}</p>
<p>Finally, light-level geolocation is one of the fundamental  techniques used to determine the paths taken during migration.




<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#hill2001etatimfrmatifbafv1"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="R.D."><span itemprop="familyName">Hill</span></span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="M.J."><span itemprop="familyName">Braun</span></span>,&#32;<span itemprop="datePublished">2001</span></a><span class="hugo-cite-citation"> 










<span itemscope 
      itemtype="https://schema.org/Chapter"
      data-type="chapter">
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hill</span>,&#32;
    <meta itemprop="givenName" content="R.D." />
    R.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Braun</span>,&#32;
    <meta itemprop="givenName" content="M.J." />
    M.</span>
  &#32;
    (<span itemprop="datePublished">2001</span>).
  &#32;<span itemprop="name">Geolocation by Light Level</span>.&#32;In<span itemprop="about">
    <i>Electronic Tagging and Tracking in Marine Fisheries. Reviews: Methods and Technologies in Fish Biology and Fisheries, vol 1.</i></span>..
  
  <a href="https://doi.org/10.1007/978-94-017-1402-0_17"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1007/978-94-017-1402-0_17</a></span>




</span></span>)</span>
, 




<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#fudickar2012mee"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Adam M"><span itemprop="familyName">Fudickar</span></span>,&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Martin"><span itemprop="familyName">Wikelski</span></span>
                  <em>&amp; al.</em>,&#32;<span itemprop="datePublished">2012</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Fudickar</span>,&#32;
    <meta itemprop="givenName" content="Adam M" />
    A.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Wikelski</span>,&#32;
    <meta itemprop="givenName" content="Martin" />
    M.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Partecke</span>,&#32;
    <meta itemprop="givenName" content="Jesko" />
    J.</span>
  &#32;
    (<span itemprop="datePublished">2012</span>).
  &#32;<span itemprop="name">Tracking migratory songbirds: Accuracy of light-level loggers (geolocators) in forest habitats</span>.<i>
    <span itemprop="about">Methods in Ecology and Evolution</span>,&#32;3(1)</i>.&#32;<span itemprop="pagination">47–52</span>.
  <a href="https://doi.org/10.1111/j.2041-210X.2011.00136.x"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1111/j.2041-210X.2011.00136.x</a></span>




</span></span>)</span>

While commercial light-level geolocation tags are available, geolocation in combination with acceleration or altitude data seems  especially useful.</p>
<p>In practice, it may be desirable for specific experiments to combine various combinations of these sensors.  For example,
light, pressure, and temperature can be combined with weather data to determine altitude.  Pressure, temperature, an altitude  have been used to study the flight behavior of soaring birds. 




<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#williams2020p"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="H. J."><span itemprop="familyName">Williams</span></span>,&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="E. L. C."><span itemprop="familyName">Shepard</span></span>
                  <em>&amp; al.</em>,&#32;<span itemprop="datePublished">2020</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Williams</span>,&#32;
    <meta itemprop="givenName" content="H. J." />
    H.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Shepard</span>,&#32;
    <meta itemprop="givenName" content="E. L. C." />
    E.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Holton</span>,&#32;
    <meta itemprop="givenName" content="Mark D." />
    M.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Alarcón</span>,&#32;
    <meta itemprop="givenName" content="P. a. E." />
    P.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Wilson</span>,&#32;
    <meta itemprop="givenName" content="R. P." />
    R.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Lambertucci</span>,&#32;
    <meta itemprop="givenName" content="S. A." />
    S.</span>
  &#32;
    (<span itemprop="datePublished">2020</span>).
  &#32;<span itemprop="name">Physical limits of flight performance in the heaviest soaring bird</span>.<i>
    <span itemprop="about">Proceedings of the National Academy of Sciences</span>,&#32;117(30)</i>.&#32;<span itemprop="pagination">17884–17890</span>.
  <a href="https://doi.org/10.1073/pnas.1907360117"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1073/pnas.1907360117</a></span>




</span></span>)</span>
.  In addition, the data collection  protocol might vary considerably for different types of experiments.  In some cases, high frequency data for days or weeks is  required while in migration studies lower frequency data over months is required.</p>
<h2 id="results">Results</h2>
<p>We &ldquo;built&rdquo; three prototype tags using the breakout board illustrated in Fig.~\ref{fig:tagbreakout},
commercial sensor evaluation boards for the accelerometer (STEVAL-MKI179V1) and pressure sensor  (STEVAL-MKI213V1) tags; and  a custom sensor board for the light sensor board.  The accelerometer was configured to be ``always on'' and the
other sensors had their power supplied through a processor pin.  We modified the pressure sensor board by removing
a $10 \mu F$ capacitor.</p>
<p>The data collection protocol for all three tags was synchronous &ndash; based upon a configured period (e.g. 60 seconds),
a running tag wakes, measures the required data, and stores one or more values. The light sensor tag collects a single
value &ndash; the received optical power in $\frac{nW}{cm^2}$.  The pressure
sensor tag collects two values &ndash; the pressure in hPA and the temperature in $\circ C$. The LPS27
pressure sensor was configured in ``low-current mode'' (5.6Pa RMS noise).  Similarly, the OPT3002 was configured
for the shorter 100ms conversion time with somewhat reduced resolution.</p>
<p>The data  collection protocol for the acceleration tag is more complex.  The tag stores two values for each collection
period &ndash; pitch angle of the tag and VeDBA (vector dynamic acceleration) averaged over a sampling window.
The tag was  configured to collect 14-bit data in ``low-power mode 1'' (4.5mg RMS noise)
and to utilize both low and high-pass filters to measure static and dynamic acceleration, respectively.  In both cases the filters are configured with cutoff frequencies
$\frac{1}{20}$ of the 25Hz sample rate.  For static acceleration, data were collected and discarded for
12 sample periods to satisfy the filter delay.  The resulting static acceleration vector ($g_x,g_y,g_z$)
was used to compute the pitch angle $\theta$ using the formula
$$ \theta\ = \ \frac{-g_x}{\sqrt{g_y^2+g_z^2}} $$
For dynamic acceleration, VeDBA was computed and averaged over 1 second.
In practice, both sample rates and sampling duration should be chosen to match the wing-beat frequency and
flap-glide patterns for the species under study. 




<span class="hugo-cite-intext"
        itemprop="citation">(<span class="hugo-cite-group">

          <a href="#bruderer2010ia"><span class="visually-hidden">Citation: </span><span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Bruno"><span itemprop="familyName">Bruderer</span></span>,&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="givenName" content="Dieter"><span itemprop="familyName">Peter</span></span>
                  <em>&amp; al.</em>,&#32;<span itemprop="datePublished">2010</span></a><span class="hugo-cite-citation"> 










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bruderer</span>,&#32;
    <meta itemprop="givenName" content="Bruno" />
    B.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Peter</span>,&#32;
    <meta itemprop="givenName" content="Dieter" />
    D.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Boldt</span>,&#32;
    <meta itemprop="givenName" content="Andreas" />
    A.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Liechti</span>,&#32;
    <meta itemprop="givenName" content="Felix" />
    F.</span>
  &#32;
    (<span itemprop="datePublished">2010</span>).
  &#32;<span itemprop="name">Wing-beat characteristics of birds recorded with tracking radar and cine camera</span>.<i>
    <span itemprop="about">Ibis</span>,&#32;152(2)</i>.&#32;<span itemprop="pagination">272–291</span>.
  <a href="https://doi.org/https://doi.org/10.1111/j.1474-919X.2010.01014.x"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/https://doi.org/10.1111/j.1474-919X.2010.01014.x</a></span>




</span></span>)</span>
</p>
<p>As described previously, the daughter card we developed has a 4MByte flash
memory.  In all three tags, data were stored as two-byte values. Thus, the prototype tags have
sufficient storage for 2M samples &ndash; in practice energy will likely be the limiting factor.
For example,  the pressure and accelerometer tags have storage for a year with a 30 second
sample period.</p>
<p>The following table provides the energy measurements obtained with our development platform and the
data collection protocols described above.  The table includes the idle current, cost of a single data sample, and
expected lifetime with three possible batteries (MS518, MS614, and MS920).  The expected
mass with these batteries, based upon footprints that are identical to the BitTag are (0.5g, 0.6g, and 0.85g, respectively).</p>
<table>
<thead>
<tr>
<th style="text-align:center">Sensor</th>
<th style="text-align:center">Idle (nA)</th>
<th style="text-align:center">Sample (uJ)</th>
<th style="text-align:center">MS518</th>
<th style="text-align:center">MS614</th>
<th style="text-align:center">MS920</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Accelerometer</td>
<td style="text-align:center">300nA</td>
<td style="text-align:center">57uJ</td>
<td style="text-align:center">208 days</td>
<td style="text-align:center">337 days</td>
<td style="text-align:center">674 days</td>
</tr>
<tr>
<td style="text-align:center">Pressure</td>
<td style="text-align:center">230nA</td>
<td style="text-align:center">30uJ</td>
<td style="text-align:center">329 days</td>
<td style="text-align:center">532 days</td>
<td style="text-align:center">1065 days</td>
</tr>
<tr>
<td style="text-align:center">Light</td>
<td style="text-align:center">260nA</td>
<td style="text-align:center">21.4uJ</td>
<td style="text-align:center">351 days</td>
<td style="text-align:center">569 days</td>
<td style="text-align:center">1138 days</td>
</tr>
</tbody>
</table>
<h2 id="required-software-changes">Required Software Changes</h2>
<p>It is somewhat challenging to quantify the software changes required to create new tags.  The most time-consuming part
is developing the code (driver) that controls the new sensors or other hardware devices.  Although,
for each of the sensors this ``driver'' code was less than  200 lines of C, writing the code required carefully reading and interpreting the sensor datasheet.  In addition, all of the
three tags utilize an external flash chip that was not part of the BitTag.  While the code to support this flash chip, which we developed for an earlier project, is only about 300 lines, the effort required was substantial.
Since all of the drivers developed in this project are reusable for other tags, in the following we focus on the
other differences between our three example tags and the code necessary to integrate them into our host software.</p>
<p>Each of the three codes differs slightly in three areas &ndash; configuration, logging, and data transfer.
The specific code for logging data differs between the tags by fewer than 50 lines of code
and the code for handling the new log messages differs by fewer than 50 lines between the various tags. For these
examples, we made a single change to the configuration system &ndash; adding a sample period parameter that was
not needed in BitTag, which samples based upon asynchronous activity.</p>
<p>On the host software side, each of the tags required a new routine for converting logging messages to text &ndash; approximately  100 lines of code for each including integration into the GUI tool and code libraries.
Extending the protocol definitions to support the new  logging and configuration messages required approximately 50 lines of code.</p>
<p>Finally, for each tag we needed to integrate the code into the software build system. Although this requires
only a few small changes, it does require knowledge of our build environment.</p>
<h2 id="other-considerations">Other Considerations</h2>
<h3 id="capacitor-leakage">Capacitor Leakage</h3>
<p>An important potential loss is due to the leakage current of the capacitors that are necessary
to smooth power delivery in our circuits.   A primary source of these losses is due to the insulation resistance of the capacitors
themselves &ndash; which is specified by suppliers.  Typically, this is specified in $\Omega F $  for example,
Murata specifies $ 50\ \Omega F $ for many its parts.  We can calculate the expected leakage of a
$ 1\mu F $ capacitor at 2.5V as follows:</p>
<ul>
<li>IR : $  = 50\ \Omega F/1\mu F \ = 50\times 10^{-6} \Omega $</li>
<li>Leakage = $  2.5V/50\times 10^{-6} \Omega  = 50 nA $</li>
</ul>
<p>Using the same formula, here are some the leakage currents at 2.5V for various capacitor sizes:</p>
<table>
<thead>
<tr>
<th>Capacitor</th>
<th>Leakage (nA)</th>
</tr>
</thead>
<tbody>
<tr>
<td>$ 0.1\mu F $</td>
<td>5 nA</td>
</tr>
<tr>
<td>$ 1\mu F $</td>
<td>50 nA</td>
</tr>
<tr>
<td>$ 4.7\mu F $</td>
<td>235 nA</td>
</tr>
<tr>
<td>$ 10\mu F $</td>
<td>500 nA</td>
</tr>
</tbody>
</table>
<p>Given that our entire steady-state budget is under (hopefully way under) $ 1\mu A $,
it&rsquo;s clear that we need to be thoughtful about our use of larger value capacitors.  There is some good news &ndash; the
insulation resistance formula is very conservative (perhaps as much a 10x) as described in this <a href="https://escies.org/download/webDocumentFile?id=60885">study</a>.</p>
<p>Most of the capacitors in our tag designs are quite small; however, we do require at least one larger capacitor to support
writing the on-chip flash.  For the stm32l4 processors, writing 64-bits takes $ 90\mu s $ at $
3.4 mA $ or
$  2.5 V \times 3.4 \times 10^{-3} A \times 9.0 \times 10^{-5} s == 0.765 \mu J $
at 2.5 Volts.
The energy stored in a capacitor is
$ \frac{1}{2}CV^2 $</p>
<p>Suppose that we want to limit voltage sag to 0.1V then, we can compute the size capactor required as</p>
<p>$  \frac{1}{2}C (2.5^2 - 2.4^2) = 0.765 \times 10^{-6} $</p>
<p>$  C = \frac{2 \times 0.765 \times 10^{-6}}{0.49}  = 3 \mu F $</p>
<p>At 2V (the minimum viable battery voltage), a $ 3.7 \mu F $
capacitor is needed.
Thus, a $ 4.7 \mu F $ capacitor provides sufficient storage to
handle 64-bit writes with less than 0.1V voltage drop.</p>
<h3 id="fabrication-constraints">Fabrication Constraints</h3>
<p>In order to facilitate the production of inexpensive prototypes and small fabrication runs, it is essential to use design constraints that are readily satisfied by low-cost providers.  These constraints limit the design of the PCB (pc-boards) and
the choice of component packages.  For example, the smallest processor packages available are in so-called Wafer chip scale
packages  (WCSP) where the package size is essentially the semiconductor die size; however, the spacing of the pins for these packages is typically too close for low-cost low-volume production.  Similarly, the smallest passive devices (capacitors and resistors) are available in 0201 packages (0.6mm x 0.3mm), while most of the fab houses we work with are recommend 0402 (1mm x 0.5mm).</p>
<p>In developing prototypes we have primarily used two suppliers &ndash; Macrofab and PCB:ng.  For production runs we have used Macrofab and Circuit Hub.   Here are a subset of their design rules (0.001in == 1mil).</p>
<table>
<thead>
<tr>
<th>Supplier</th>
<th>Minimum Trace Width</th>
<th>Minimum Via Diameter</th>
<th>Smallest Package</th>
</tr>
</thead>
<tbody>
<tr>
<td>Circuit Hub</td>
<td>6 mil</td>
<td>12 mil (24 recommended)</td>
<td>0402 (recommended)</td>
</tr>
<tr>
<td>MacroFab</td>
<td>5 mil</td>
<td>18 mil</td>
<td>0201</td>
</tr>
<tr>
<td>PCB:ng</td>
<td>4 mil</td>
<td>18 mil</td>
<td>0201</td>
</tr>
<tr>
<td>Our designs</td>
<td>5 mil</td>
<td>23 mil</td>
<td>0402</td>
</tr>
</tbody>
</table>
<h2 id="references">References</h2>

  

  










<section class="hugo-cite-bibliography">
  <dl>
    

      <div id="bruderer2010ia">
        <dt>
          Bruderer,&#32;
          Peter,&#32;
          Boldt&#32;&amp;&#32;Liechti

          
          (2010)</dt>

        <dd>
          










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bruderer</span>,&#32;
    <meta itemprop="givenName" content="Bruno" />
    B.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Peter</span>,&#32;
    <meta itemprop="givenName" content="Dieter" />
    D.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Boldt</span>,&#32;
    <meta itemprop="givenName" content="Andreas" />
    A.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Liechti</span>,&#32;
    <meta itemprop="givenName" content="Felix" />
    F.</span>
  &#32;
    (<span itemprop="datePublished">2010</span>).
  &#32;<span itemprop="name">Wing-beat characteristics of birds recorded with tracking radar and cine camera</span>.<i>
    <span itemprop="about">Ibis</span>,&#32;152(2)</i>.&#32;<span itemprop="pagination">272–291</span>.
  <a href="https://doi.org/https://doi.org/10.1111/j.1474-919X.2010.01014.x"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/https://doi.org/10.1111/j.1474-919X.2010.01014.x</a></span>




</dd>

      </div>

      <div id="dhanjal-adams2018cb">
        <dt>
          Dhanjal-Adams,&#32;
          Bauer,&#32;
          Emmenegger,&#32;
          Hahn,&#32;
          Lisovski&#32;&amp;&#32;Liechti

          
          (2018)</dt>

        <dd>
          










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Dhanjal-Adams</span>,&#32;
    <meta itemprop="givenName" content="Kiran L." />
    K.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bauer</span>,&#32;
    <meta itemprop="givenName" content="Silke" />
    S.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Emmenegger</span>,&#32;
    <meta itemprop="givenName" content="Tamara" />
    T.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hahn</span>,&#32;
    <meta itemprop="givenName" content="Steffen" />
    S.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Lisovski</span>,&#32;
    <meta itemprop="givenName" content="Simeon" />
    S.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Liechti</span>,&#32;
    <meta itemprop="givenName" content="Felix" />
    F.</span>
  &#32;
    (<span itemprop="datePublished">2018</span>).
  &#32;<span itemprop="name">Spatiotemporal Group Dynamics in a Long-Distance Migratory Bird</span>.<i>
    <span itemprop="about">Current Biology</span>,&#32;28(17)</i>.&#32;<span itemprop="pagination">2824–2830.e3</span>.
  <a href="https://doi.org/10.1016/j.cub.2018.06.054"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1016/j.cub.2018.06.054</a></span>




</dd>

      </div>

      <div id="fudickar2012mee">
        <dt>
          Fudickar,&#32;
          Wikelski&#32;&amp;&#32;Partecke

          
          (2012)</dt>

        <dd>
          










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Fudickar</span>,&#32;
    <meta itemprop="givenName" content="Adam M" />
    A.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Wikelski</span>,&#32;
    <meta itemprop="givenName" content="Martin" />
    M.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Partecke</span>,&#32;
    <meta itemprop="givenName" content="Jesko" />
    J.</span>
  &#32;
    (<span itemprop="datePublished">2012</span>).
  &#32;<span itemprop="name">Tracking migratory songbirds: Accuracy of light-level loggers (geolocators) in forest habitats</span>.<i>
    <span itemprop="about">Methods in Ecology and Evolution</span>,&#32;3(1)</i>.&#32;<span itemprop="pagination">47–52</span>.
  <a href="https://doi.org/10.1111/j.2041-210X.2011.00136.x"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1111/j.2041-210X.2011.00136.x</a></span>




</dd>

      </div>

      <div id="gleiss2011mee">
        <dt>
          Gleiss,&#32;
          Wilson&#32;&amp;&#32;Shepard

          
          (2011)</dt>

        <dd>
          










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Gleiss</span>,&#32;
    <meta itemprop="givenName" content="Adrian C." />
    A.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Wilson</span>,&#32;
    <meta itemprop="givenName" content="Rory P." />
    R.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Shepard</span>,&#32;
    <meta itemprop="givenName" content="Emily L. C." />
    E.</span>
  &#32;
    (<span itemprop="datePublished">2011</span>).
  &#32;<span itemprop="name">Making overall dynamic body acceleration work: on the theory of acceleration as a proxy for energy expenditure</span>.<i>
    <span itemprop="about">Methods in Ecology and Evolution</span>,&#32;2(1)</i>.&#32;<span itemprop="pagination">23–33</span>.
  <a href="https://doi.org/https://doi.org/10.1111/j.2041-210X.2010.00057.x"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/https://doi.org/10.1111/j.2041-210X.2010.00057.x</a></span>




</dd>

      </div>

      <div id="hedenstrom2016cb">
        <dt>
          Hedenström,&#32;
          Norevik,&#32;
          Warfvinge,&#32;
          Andersson,&#32;
          Bäckman&#32;&amp;&#32;Åkesson

          
          (2016)</dt>

        <dd>
          










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hedenström</span>,&#32;
    <meta itemprop="givenName" content="Anders" />
    A.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Norevik</span>,&#32;
    <meta itemprop="givenName" content="Gabriel" />
    G.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Warfvinge</span>,&#32;
    <meta itemprop="givenName" content="Kajsa" />
    K.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Andersson</span>,&#32;
    <meta itemprop="givenName" content="Arne" />
    A.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bäckman</span>,&#32;
    <meta itemprop="givenName" content="Johan" />
    J.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Åkesson</span>,&#32;
    <meta itemprop="givenName" content="Susanne" />
    S.</span>
  &#32;
    (<span itemprop="datePublished">2016</span>).
  &#32;<span itemprop="name">Annual 10-Month Aerial Life Phase in the Common Swift Apus apus</span>.<i>
    <span itemprop="about">Current Biology</span>,&#32;26(22)</i>.&#32;<span itemprop="pagination">3066–3070</span>.
  <a href="https://doi.org/10.1016/j.cub.2016.09.014"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1016/j.cub.2016.09.014</a></span>




</dd>

      </div>

      <div id="hill2001etatimfrmatifbafv1">
        <dt>
          Hill&#32;&amp;&#32;Braun

          
          (2001)</dt>

        <dd>
          










<span itemscope 
      itemtype="https://schema.org/Chapter"
      data-type="chapter">
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hill</span>,&#32;
    <meta itemprop="givenName" content="R.D." />
    R.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Braun</span>,&#32;
    <meta itemprop="givenName" content="M.J." />
    M.</span>
  &#32;
    (<span itemprop="datePublished">2001</span>).
  &#32;<span itemprop="name">Geolocation by Light Level</span>.&#32;In<span itemprop="about">
    <i>Electronic Tagging and Tracking in Marine Fisheries. Reviews: Methods and Technologies in Fish Biology and Fisheries, vol 1.</i></span>..
  
  <a href="https://doi.org/10.1007/978-94-017-1402-0_17"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1007/978-94-017-1402-0_17</a></span>




</dd>

      </div>

      <div id="liechti2013nc">
        <dt>
          Liechti,&#32;
          Witvliet,&#32;
          Weber&#32;&amp;&#32;Bächler

          
          (2013)</dt>

        <dd>
          










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Liechti</span>,&#32;
    <meta itemprop="givenName" content="Felix" />
    F.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Witvliet</span>,&#32;
    <meta itemprop="givenName" content="Willem" />
    W.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Weber</span>,&#32;
    <meta itemprop="givenName" content="Roger" />
    R.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bächler</span>,&#32;
    <meta itemprop="givenName" content="Erich" />
    E.</span>
  &#32;
    (<span itemprop="datePublished">2013</span>).
  &#32;<span itemprop="name">First evidence of a 200-day non-stop flight in a bird</span>.<i>
    <span itemprop="about">Nature Communications</span>,&#32;4(1)</i>.&#32;<span itemprop="pagination">2554–2554</span>.
  <a href="https://doi.org/10.1038/ncomms3554"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1038/ncomms3554</a></span>




</dd>

      </div>

      <div id="liechti2018me">
        <dt>
          Liechti,&#32;
          Bauer,&#32;
          Dhanjal-Adams,&#32;
          Emmenegger,&#32;
          Zehtindjiev&#32;&amp;&#32;Hahn

          
          (2018)</dt>

        <dd>
          










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Liechti</span>,&#32;
    <meta itemprop="givenName" content="Felix" />
    F.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bauer</span>,&#32;
    <meta itemprop="givenName" content="Silke" />
    S.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Dhanjal-Adams</span>,&#32;
    <meta itemprop="givenName" content="Kiran L." />
    K.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Emmenegger</span>,&#32;
    <meta itemprop="givenName" content="Tamara" />
    T.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Zehtindjiev</span>,&#32;
    <meta itemprop="givenName" content="Pavel" />
    P.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hahn</span>,&#32;
    <meta itemprop="givenName" content="Steffen" />
    S.</span>
  &#32;
    (<span itemprop="datePublished">2018</span>).
  &#32;<span itemprop="name">Miniaturized multi-sensor loggers provide new insight into year-round flight behaviour of small trans-Sahara avian migrants</span>.<i>
    <span itemprop="about">Movement Ecology</span>,&#32;6(1)</i>.&#32;<span itemprop="pagination">19–19</span>.
  <a href="https://doi.org/10.1186/s40462-018-0137-1"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1186/s40462-018-0137-1</a></span>




</dd>

      </div>

      <div id="sjoberg2021sa">
        <dt>
          Sjöberg,&#32;
          Malmiga,&#32;
          Nord,&#32;
          Andersson,&#32;
          Bäckman,&#32;
          Tarka,&#32;
          Willemoes,&#32;
          Thorup,&#32;
          Hansson,&#32;
          Alerstam&#32;&amp;&#32;Hasselquist

          
          (2021)</dt>

        <dd>
          










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Sjöberg</span>,&#32;
    <meta itemprop="givenName" content="Sissel" />
    S.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Malmiga</span>,&#32;
    <meta itemprop="givenName" content="Gintaras" />
    G.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Nord</span>,&#32;
    <meta itemprop="givenName" content="Andreas" />
    A.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Andersson</span>,&#32;
    <meta itemprop="givenName" content="Arne" />
    A.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bäckman</span>,&#32;
    <meta itemprop="givenName" content="Johan" />
    J.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Tarka</span>,&#32;
    <meta itemprop="givenName" content="Maja" />
    M.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Willemoes</span>,&#32;
    <meta itemprop="givenName" content="Mikkel" />
    M.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Thorup</span>,&#32;
    <meta itemprop="givenName" content="Kasper" />
    K.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hansson</span>,&#32;
    <meta itemprop="givenName" content="Bengt" />
    B.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Alerstam</span>,&#32;
    <meta itemprop="givenName" content="Thomas" />
    T.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hasselquist</span>,&#32;
    <meta itemprop="givenName" content="Dennis" />
    D.</span>
  &#32;
    (<span itemprop="datePublished">2021</span>).
  &#32;<span itemprop="name">Extreme altitudes during diurnal flights in a nocturnal songbird migrant</span>.<i>
    <span itemprop="about">Science</span>,&#32;372(6542)</i>.&#32;<span itemprop="pagination">646–648</span>.
  <a href="https://doi.org/10.1126/science.abe7291"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1126/science.abe7291</a></span>




</dd>

      </div>

      <div id="spivey2013jotrsi">
        <dt>
          Spivey&#32;&amp;&#32;Bishop

          
          (2013)</dt>

        <dd>
          










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Spivey</span>,&#32;
    <meta itemprop="givenName" content="R. J." />
    R.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Bishop</span>,&#32;
    <meta itemprop="givenName" content="C. M." />
    C.</span>
  &#32;
    (<span itemprop="datePublished">2013</span>).
  &#32;<span itemprop="name">Interpretation of body-mounted accelerometry in flying animals and estimation of biomechanical power</span>.<i>
    <span itemprop="about">Journal of The Royal Society Interface</span>,&#32;10(87)</i>.&#32;<span itemprop="pagination">20130404</span>.
  <a href="https://doi.org/10.1098/rsif.2013.0404"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1098/rsif.2013.0404</a></span>




</dd>

      </div>

      <div id="stothart2016jeb">
        <dt>
          Stothart,&#32;
          Elliott,&#32;
          Wood,&#32;
          Hatch&#32;&amp;&#32;Speakman

          
          (2016)</dt>

        <dd>
          










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Stothart</span>,&#32;
    <meta itemprop="givenName" content="Mason R." />
    M.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Elliott</span>,&#32;
    <meta itemprop="givenName" content="Kyle H." />
    K.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Wood</span>,&#32;
    <meta itemprop="givenName" content="Thomas" />
    T.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Hatch</span>,&#32;
    <meta itemprop="givenName" content="Scott A." />
    S.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Speakman</span>,&#32;
    <meta itemprop="givenName" content="John R." />
    J.</span>
  &#32;
    (<span itemprop="datePublished">2016</span>).
  &#32;<span itemprop="name">Counting calories in cormorants: dynamic body acceleration predicts daily energy expenditure measured in pelagic cormorants</span>.<i>
    <span itemprop="about">Journal of Experimental Biology</span></i>.&#32;<span itemprop="pagination">jeb.130526</span>.
  <a href="https://doi.org/10.1242/jeb.130526"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1242/jeb.130526</a></span>




</dd>

      </div>

      <div id="williams2015ab">
        <dt>
          Williams,&#32;
          Shepard,&#32;
          Duriez&#32;&amp;&#32;Lambertucci

          
          (2015)</dt>

        <dd>
          










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Williams</span>,&#32;
    <meta itemprop="givenName" content="H. J." />
    H.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Shepard</span>,&#32;
    <meta itemprop="givenName" content="E. L.C. C" />
    E.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Duriez</span>,&#32;
    <meta itemprop="givenName" content="O." />
    O.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Lambertucci</span>,&#32;
    <meta itemprop="givenName" content="S. A." />
    S.</span>
  &#32;
    (<span itemprop="datePublished">2015</span>).
  &#32;<span itemprop="name">Can accelerometry be used to distinguish between flight types in soaring birds?</span>.<i>
    <span itemprop="about">Animal Biotelemetry</span>,&#32;3(1)</i>.&#32;<span itemprop="pagination">45–45</span>.
  <a href="https://doi.org/10.1186/s40317-015-0077-0"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1186/s40317-015-0077-0</a></span>




</dd>

      </div>

      <div id="williams2020p">
        <dt>
          Williams,&#32;
          Shepard,&#32;
          Holton,&#32;
          Alarcón,&#32;
          Wilson&#32;&amp;&#32;Lambertucci

          
          (2020)</dt>

        <dd>
          










<span itemscope
      itemtype="https://schema.org/Article"
      data-type="article"><span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Williams</span>,&#32;
    <meta itemprop="givenName" content="H. J." />
    H.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Shepard</span>,&#32;
    <meta itemprop="givenName" content="E. L. C." />
    E.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Holton</span>,&#32;
    <meta itemprop="givenName" content="Mark D." />
    M.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Alarcón</span>,&#32;
    <meta itemprop="givenName" content="P. a. E." />
    P.</span>,&#32;
  <span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Wilson</span>,&#32;
    <meta itemprop="givenName" content="R. P." />
    R.</span>&#32;&amp;&#32;<span itemprop="author" itemscope itemtype="https://schema.org/Person"><span itemprop="familyName">Lambertucci</span>,&#32;
    <meta itemprop="givenName" content="S. A." />
    S.</span>
  &#32;
    (<span itemprop="datePublished">2020</span>).
  &#32;<span itemprop="name">Physical limits of flight performance in the heaviest soaring bird</span>.<i>
    <span itemprop="about">Proceedings of the National Academy of Sciences</span>,&#32;117(30)</i>.&#32;<span itemprop="pagination">17884–17890</span>.
  <a href="https://doi.org/10.1073/pnas.1907360117"
     itemprop="identifier"
     itemtype="https://schema.org/URL">https://doi.org/10.1073/pnas.1907360117</a></span>




</dd>

      </div>
  </dl>
</section>




</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8024bfd9db67c19d8af83c6399e34b5d">5 - Installation</h1>
    <div class="lead">Installing and building software and hardware design files</div>
	<p>The tag system consists of software, both host and embedded, and hardware including printed circuit boards (PCBs) and 3D printed adapters.  Consequently, there are a relatively large number of software tools involved.   All of the software and
hardware designs (source code) are available in the <a href="https://git.iu.edu/geobrown/Nanotag-paper">github repository</a>.  While you can explore that repository on-line, in order to compile the code and generate the processing files necessary to build boards, it is necessary to first
<em>clone</em> the repository as described in <a href="#install-1">Installing the Repository</a></p>
<p>An
abbreviated view of this repository is shown in the following
figure. There are two directories containing the designs for
this project &ndash; software and hardware.  Two directories that
reference code from other projects as <em>submodules</em> &ndash; nanopb, which
provides the compiler and libraries for the communication protocols
used to exchange data and control messages with the tags, and
ChibiOS, which is the embedded operating system (RTOS) used in the
tags.  Finally there is a directory (cmake) and files (CMakeLists.txt) used by the CMake build system.</p>
<p><strong>Note</strong> it&rsquo;s better to install nanopb from the available binary as this is less likely to have version problems with the install protoc</p>
<pre tabindex="0"><code>.
├── ChibiOS
├── cmake
├── CMakeLists.txt
├── hardware
│   ├── AccelTag
│   ├── BitTagv5
│   ├── BitTagv7
│   ├── CMakeLists.txt
│   ... 
│   ├── Mechanical
│   ...
├── nanopb
├── README.md
└── software
    ├── CMakeLists.txt
    ├── embedded
    ├── host
    ├── include
    └── proto
</code></pre><p>The hardware directory contains a separate directory for each board,
libraries used by the Kicad, the computer aided design system (CAD) that we use to design hardware, and a directory of mechanical
components (Mechanical) that includes the design files for the 3D
printed bases.</p>
<p>The software directory includes separate sub-directories for embedded and host code, and a directory for the protocol definitions used to communicate between the host and the tags.</p>
<p>All of the software and hardware for tags can be compiled (built) on Windows, OS X, or Linux.  Enabling this process requires
installing a number of programs and libraries.  There are
differences in the installation and build process for the three
platforms that will be called out.  In this section we describe
the processes for <em>cloning</em> the tag repository and installing the CMake build system.  The tools and libraries required to perform a build are discussed in separate sections for
hardware and software.</p>
<h2 id="install-1">1. Installing the Repository</h2>
<p>In order to install the repository, you should use the program <code>git</code>, which is available on Windows, OS X, and Linux. Instructions
for installing <code>git</code> can be found <a href="https://git-scm.com/downloads">here</a></p>
<p>Once git is installed, copy the git repo link (for https) and execute the following in a terminal within the directory where you would like the repo installed</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">git clone https://github.iu.edu/geobrown/NanoTag-paper.git target_directory_name
<span style="color:#204a87">cd</span> target_directory_name
git submodule update --init --recursive 
</code></pre></div><p>The repository for this project includes one <em>submodules</em> &ndash; ChibiOS; these are external repositories upon which our system builds. Nanopb used to be installed as a submodule but it&rsquo;s best to install the available binary distribution in the named directory. Nanopb is a code library and tool for creating the communication code used in our tags to communicate with the host applications.  ChibiOS is an excellent embedded operating systems that is used on our tags.</p>
<p>The line <code>git submodule...</code> initializes these submodules and clones their contents.</p>
<h2 id="2-installing-the-cmake-build-tool">2. Installing the CMake Build Tool</h2>
<p>In order to automate the process of <em>building</em> the various system components, we use
the CMake tool.  This tool checks for the presence of all other necessary tools and issues warnings for any tools that are missing.</p>
<p><a href="https://cmake.org/download/">Cmake on OS X</a></p>
<h3 id="additional-installation-for-windows">Additional Installation For Windows</h3>
<p>make &ndash; gnu make is needed for building embedded software.  The easiest way to install gnu make is with the <code>chocolaty</code> package manager.  <a href="https://community.chocolatey.org/packages/make">choco</a></p>
<p>Setting up paths  <a href="https://david.gardiner.net.au/2020/04/powershell-visualstudio-integration.html">https://david.gardiner.net.au/2020/04/powershell-visualstudio-integration.html</a>
<a href="https://docs.microsoft.com/en-us/visualstudio/ide/reference/command-prompt-powershell?view=vs-2019#windows-10">https://docs.microsoft.com/en-us/visualstudio/ide/reference/command-prompt-powershell?view=vs-2019#windows-10</a></p>
<h3 id="building-with-cmake-additional-softare-required">Building with CMake (additional softare required)</h3>
<p>Assuming all the necessary tools are installed the build process consists of creating a build directory, running CMake from within that directory, and then <em>making</em> any desired components.  On a linux system, for example, the following sequence of commands will build the BitTag data visualization tool <code>btviz</code>.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mkdir build_directory
<span style="color:#204a87">cd</span> build_directory
cmake path_to_repository
make btviz
</code></pre></div><p>The first two lines create a directory in which to <em>build</em> the system components;
the third line populates this directory with the scripts necessary to perform the build (in this case Unix &ldquo;make&rdquo; files); finally, the fourth line builds the &ldquo;target&rdquo; btviz.<br>
Continuing the example, one can build and download the firmware to a BitTag (e.g. v6) that is connected to a base:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">make BitTagv6-download
</code></pre></div><p>The CMake build tool can be installed from <a href="https://cmake.org/download/">here</a>.</p>
<p>The various software <em>targets</em> that can be built include</p>
<ul>
<li>Host Tools
<ul>
<li>qtmonitor &ndash; the tag configuration tool</li>
<li>btviz &ndash; the BitTag visualization tool</li>
<li>various command-line tools</li>
</ul>
</li>
<li>Tags
<ul>
<li>AccelTag &ndash; Tag design with ST Accelerometer</li>
<li>BitTagv5 &ndash; BitTag with rv-8803 temperature compensated RTC</li>
<li>BitTagv7 &ndash; BitTag with rv-3028 45nA RTC</li>
<li>LuxTag   &ndash; Tag design with light sensor</li>
<li>NucleoTag &ndash; Tag &ldquo;design&rdquo; using STM Nucleo board for demonstration</li>
<li>PresTAg  &ndash; Tag design with LPS27 Pressure sensor</li>
</ul>
</li>
<li>Bases
<ul>
<li>bittag-base-jlcpcb-v3[-dfu] &ndash; Tag base (-dfu for programming)</li>
<li>tag-breakout-base-jlcpcb32-v1[-dfu] &ndash; Tag breakout board stlink interface</li>
</ul>
</li>
</ul>
<p>In addition, cmake files are provided for generating gerber and outline files for the following hardware:</p>
<ul>
<li>AccelTag-pcb &ndash; AccelTag board</li>
<li>tagbase-jlcpcb-v3 &ndash; Tag base board</li>
<li>MultiCharger-pcb &ndash; Tag charger board</li>
</ul>
<p>Finally, the 3d printed tag adapter for BitTags can be generated</p>
<ul>
<li>multicharger-acrylic</li>
</ul>
<h2 id="3-building-on-os-x">3. Building on OS X</h2>
<p>The process for building on OS X is similar to that for Linux except that OS X applications are typically <em>bundled</em> into
<code>.app</code> directories.  To build these bundles, we depend upon
a tool, <code>macdeployqt</code>, that combines the compiled (host) applications
with any necessary libraries in an <code>.app</code> directory.  The
installation of Qt5 is discussed in the section on Software.  In order  for CMake to find <code>macdeployqt</code>, you must make sure that
the directory <code>qt/5.15.1/bin</code> is included in your bash path &ndash; note that version number 5.15.1 should be changed to fit the version of Qt5 installed.</p>
<p>All of the OS X applications created by make can be <em>packed</em> into
a singled <code>.dmg</code> file for distribution to other users.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#204a87">cd</span> build_directory
cpack -G DragNDrop
</code></pre></div><h2 id="3-building-on-windows">3. Building on Windows</h2>
<p>Unfortunately, the process for building on Windows is
significantly more complicated than for other platforms.  The
fundamental reason for this is the lack of a coherent <em>path</em> mechanism,
within a terminal window, for scripts to find applications.  This problem is particularly acute when using the compilation tools
in Visual Studio from a command line.  To mitigate this problem you
must:</p>
<ul>
<li>Use the powershell window configured for Visual Studio</li>
<li>Modify the powershell path environment variable</li>
<li>Use vcpkg to manage the various software libaries</li>
</ul>
<p>Powershell integration with visual studio is described <a href="https://david.gardiner.net.au/2020/04/powershell-visualstudio-integration.html">here</a> and <a href="https://docs.microsoft.com/en-us/visualstudio/ide/reference/command-prompt-powershell?view=vs-2019#windows-10">here</a>.  Briefly,
when Visual Studio 2019 is installed, a &ldquo;Developer PowerShell for VS 2019&rdquo; is made available in the Start menu.  This PowerShell instance has many of the required path variables installed.</p>
<p>In addition, the path environment variables should be
modified (described <a href="https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.core/about/about_environment_variables?view=powershell-7.1">here</a>) to include the
paths to the various tools used in the build process (CMake, STM32_Programmer_CLI,FMPP, etc.)</p>
<p>Finally, we use vcpkg to manage the various software libraries (described in the Software section).</p>
<p>With all that accomplished, the process of building becomes</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">mkdir build_directory
<span style="color:#204a87">cd</span> build_directory
cmake -G <span style="color:#4e9a06">&#34;Visual Studio 16 2019&#34;</span> -Ax64 -DVCPKG_TARGET_TRIPLET<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;x64-windows-static&#34;</span> -DCMAKE_TOOLCHAIN_FILE<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;path_to/vcpkg/scripts/buildsystems/vcpkg.cmake&#34;</span>  path_to_nanotag_repo
cmake --build . --config Release
</code></pre></div><p>The differences with Linux are, lines 3 and 4.  In line 3,
CMake is directed to configure the build for Visual Studio 2019 using the toolchain file from vcpkg and for a static x64 target.
Line 4 performs the actual build (this configuration does not use make files).</p>
<p>In addition to a Release configuration, one can build a Debug configuration:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cmake --build . --config Debug
</code></pre></div><p>One can build and download tags as in</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cmake --build . --target <span style="color:#ce5c00;font-weight:bold">[</span>BitTagv6<span style="color:#000;font-weight:bold">|</span>BitTagv5<span style="color:#000;font-weight:bold">|</span>NucleoTag<span style="color:#ce5c00;font-weight:bold">]</span>
cmake --build . --target BitTagv6-download
</code></pre></div><p>Furthermore, one can erase tags as in</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cmake --build . --target BitTagv6-erase.
</code></pre></div><p>Finally, one can build and download baseboard firmware:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">cmake --build . --target bittag-base-jlcpcb-v3
cmake --build . --target bittag-base-jlcpcb-v3-dfu
</code></pre></div><h1 id="building-with-os-x">building with OS X</h1>
<p>Use the &ldquo;brew&rdquo; version of QT because it links statically.</p>
<p>Make sure to add /usr/local/Cellar/qt/5.15.1/bin (or current version) to your path so that the various find_program tools work (esp macdeployqt)</p>
<p>Building the dmg file for system toos</p>
<p>cpack -G DragNDrop</p>
<h1 id="2-embedded-software">2. Embedded Software</h1>
<p>Compiling and downloading embedded software requires several additional tools.</p>
<ul>
<li><a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm">gnuarm</a></li>
<li><a href="http://fmpp.sourceforge.net/">fmpp</a></li>
<li>gnu make</li>
</ul>
<p>The primary toolchain for the stm32 processors used in all our devices is the free gunarm toolchain.  ChibiOS designs additionally require the freemarker-based file preprocessor (a java application).  On Windows it will also be necessary to install gnu make (for example from chocolaty).</p>
<p>We utilize the STMicroelectronics <a href="https://wiki.st.com/stm32mpu/wiki/STM32CubeProgrammer">stm32cube programmer</a> to program and erase both tags and baseboards.</p>
<h2 id="programming-with-stm32cube-programmer">Programming with STM32Cube Programmer</h2>
<p>The cmake configuration files include rules to download and erase tags and bases.  It is also possible to use the programmer from the command line.  The following illustrates this process on Windows.</p>
<pre tabindex="0"><code>~/Software/STM32CubeProgrammer/bin/STM32_Programmer_CLI.exe -c port=SWD mode=UR -d ch.elf -v -g 0x08000000 
</code></pre><ul>
<li><code>port=SWD</code> driver</li>
<li><code>mode=UR</code> &ndash; attach under reset</li>
<li><code>-g 0x08000000</code>  &ndash; execute program after completion</li>
<li><code>-v</code> verify</li>
<li><code>-vb 3</code>  verbose logging (for debugging)</li>
</ul>
<h3 id="dfu-for-base-boards">DFU for base boards</h3>
<p>The base boards do not have a arm debug interface and
hence are programmed using DFU mode.  To put the device in DFU mode, plug in USB while holding down the dfu button on the device.</p>
<p>Make sure a device is in dfu mode</p>
<pre tabindex="0"><code>STM32_Programmer_CLI.exe -l usb
</code></pre><p>To program from command line</p>
<pre tabindex="0"><code> ~/Software/STM32CubeProgrammer/bin/STM32_Programmer_CLI -c port=usb1 -d build/ch.elf 
</code></pre>
</div>



    
      
  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-8bcaae8ae02d9717f329a127204489a4">5.1 - Software Tools/Libraries</h1>
    
	<p>In addition to CMake and Git, which were discussed in this <a href="">Page</a>,
the host, tag, and base software requires a number of tools and libraries. To compile
the host tools, we require:</p>
<ul>
<li>A C++ compiler</li>
<li>Python (version 3.7 or later)</li>
<li><code>vcpkg</code> &ndash;    package management system (Windows only)</li>
<li><code>homebrew</code> &ndash; package management system (OS X only)</li>
</ul>
<p>We also require the following libraries</p>
<ul>
<li>Google Protocol Buffers &ndash; libraries and compiler for google protocol buffers</li>
<li>libusb &ndash; a library for interacting with USB devices</li>
<li>Qt 5 &ndash; GUI interface libraries</li>
</ul>
<p>Because we support compilation on three different types of systems, the installation process
can be involved.   The goal is to both install the tools and libraries, and to insure that CMake
can find them during the build process.  Furthermore, where possible, we would like to target
static libraries in order to make distribution of the compiled software straightforward.</p>
<h2 id="11-c-compiler">1.1 C++ Compiler</h2>
<h3 id="linux">Linux</h3>
<p>Although many Linux distributions include C++, we also require some standard development tools
in order to build the various libraries that we install.  On Ubuntu systems the compiler and these  tools can be installed from the command line:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ sudo apt update
$ sudo apt-get install build-essential
</code></pre></div><h3 id="os-x">OS X</h3>
<p>The compilation tools we need are part of <a href="https://developer.apple.com/xcode/">Xcode</a> which is
a free download.  Once Xcode is installed, you need to enable the command line tools.  In a
terminal window (/Applications/Utilities/&hellip;):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">xcode-select -inst-all
</code></pre></div><h3 id="windows">Windows</h3>
<p>Install the <a href="https://visualstudio.microsoft.com/downloads/">Visual Studio 19 Community Edition</a></p>
<h2 id="12-python">1.2 Python</h2>
<p>Install at least version 3.7.</p>
<ul>
<li><a href="https://docs.python-guide.org/starting/install3/linux/">Linux Python3</a></li>
<li><a href="https://www.python.org/downloads/macos/">OS X Python3</a></li>
<li><a href="https://www.python.org/downloads/windows/">Windows Python3</a></li>
</ul>
<h2 id="13-vcpkg-windows-only">1.3 vcpkg (Windows Only)</h2>
<p>Because Windows has a (very) broken method for managing paths to libraries and
applications, we use the <a href="https://vcpkg.io/en/getting-started.html">vcpkg</a> manager
for installing the various libraries that we require.</p>
<p>Choose an appropriate location in which to install <code>vcpkg</code>, then, in a powershell window:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ git clone https://github.com/Microsoft/vcpkg.git
$ ./vcpkg/bootstrap-vcpkg.sh
</code></pre></div><p><strong>Note</strong> you may need to add the path to git to your powershell environment, for example by adding</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell"><span style="color:#000">$env</span>:Path +<span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;;PathToGit&#34;</span>           
</code></pre></div><p>to the file <code>$Home\Documents\PowerShell\Profile.ps1</code>.</p>
<h2 id="14-homebrew-os-x-only">1.4 Homebrew (OS X only)</h2>
<p>Directions for installing homebrew are <a href="https://brew.sh/">here</a></p>
<p>The basic approach is to execute the following in a terminal window:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ /bin/bash -c <span style="color:#4e9a06">&#34;</span><span style="color:#204a87;font-weight:bold">$(</span>curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh<span style="color:#204a87;font-weight:bold">)</span><span style="color:#4e9a06">&#34;</span>
</code></pre></div><h2 id="15-protocol-buffers">1.5 Protocol Buffers</h2>
<p>Google Protocol Buffers is a fundamental tool for both host and tag software as we use
protocol files in the protocol buffer language to define host/tag communications.</p>
<h3 id="linux-1">Linux</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ apt install -y protobuf-compiler
$ protoc --version  <span style="color:#8f5902;font-style:italic"># Ensure compiler version is 3+</span>
</code></pre></div><h3 id="os-x-1">OS X</h3>
<p>Install using home brew</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ brew install protobuf
$ protoc --version  <span style="color:#8f5902;font-style:italic"># Ensure compiler version is 3+</span>
</code></pre></div><h3 id="windows-1">Windows</h3>
<p>On windows we use the vcpkg manager to handle the installation.  In a powershell
in the directory where you installed vcpkg, execute:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">$ .<span style="color:#4e9a06">\v</span>cpkg install protobuf:x64-windows-static
</code></pre></div><h2 id="3-host-software-libraries">3. Host Software Libraries</h2>
<p>Both host and embedded software require Google Protocol buffers.  In addition, the
host software requires Qt5 for graphical user interfaces and libusb to communicate with tag bases.</p>
<h3 id="os-x-2">OS X</h3>
<ul>
<li>qt5 &ndash; install with homebrew.</li>
<li>libusb &ndash; install with homebrew.</li>
</ul>
<h3 id="linux-2">Linux</h3>
<ul>
<li>qt5 &ndash; <a href="https://wiki.qt.io/Install_Qt_5_on_Ubuntu_">install</a></li>
<li>libusb &ndash; <code>sudo apt-get install libusb-dev</code></li>
</ul>
<h3 id="windows-2">Windows</h3>
<p>Building large applications on Windows is challenging because of the lack of
reasonable &ldquo;path&rdquo; mechanism allowing compilation tools to find the necessary libraries and because building portable applications requires &ldquo;collecting&rdquo; all of the necessary link libraries from the host OS. To solve the &ldquo;path&rdquo; problem, we utilize the vcpkg package manager and to solve the link library problem we utilize static builds of the necessary software libraries.</p>
<p>Instructions for installing vcpkg manager can be found <a href="https://vcpkg.io/en/getting-started.html">here</a>. Once vckpg is installed you may install the necessary packages using the following command:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-shell" data-lang="shell">vcpkg install <span style="color:#ce5c00;font-weight:bold">[</span>packages to install<span style="color:#ce5c00;font-weight:bold">]</span>
</code></pre></div><p>You will need to install the following packages:</p>
<ul>
<li>protobuf:x64-windows-static</li>
<li>qt5:x64-windows-static</li>
<li>libusb:x64-windows-static</li>
<li>angle:x64-windows-static</li>
</ul>
<p>Notice that in each case we have selected the &ldquo;static&rdquo; version of the libraries.  This ensures that the binaries that you build are portable across windows systems.  The last of these packages (angle) provides openGL graphics compatibility.</p>
<h2 id="4-embedded-tools">4. Embedded Tools</h2>
<ul>
<li>fmpp</li>
<li>java</li>
<li>gnuarm</li>
<li>st programmer</li>
</ul>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-61131c563ea2536399f3bc3a931089f1">5.2 - Building Host Software</h1>
    
	<h2 id="general">General</h2>
<ul>
<li>CMake</li>
<li>protobuf</li>
<li>nanopb  (install binary version <a href="https://jpa.kapsi.fi/nanopb/download/">https://jpa.kapsi.fi/nanopb/download/</a> in root_dir/nanopb)</li>
<li>QT5</li>
</ul>
<h2 id="host">Host</h2>
<ul>
<li>QT5</li>
<li>libusb</li>
</ul>
<h2 id="embedded">Embedded</h2>
<ul>
<li>ChibiOS  &ndash; submodule branch 20.3.x</li>
<li>GNU ARM embedded toolchain-  <a href="https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm">https://developer.arm.com/tools-and-software/open-source-software/developer-tools/gnu-toolchain/gnu-rm</a></li>
<li>fmpp freemarker file preprocessor <a href="http://fmpp.sourceforge.net/">http://fmpp.sourceforge.net/</a></li>
<li>Make (install gnu make on windows)</li>
<li>ST Cube Programmer <a href="https://www.st.com/en/development-tools/stm32cubeprog.html">https://www.st.com/en/development-tools/stm32cubeprog.html</a></li>
</ul>
<h2 id="hardware">Hardware</h2>
<ul>
<li>kicad 5 -https://www.kicad.org/</li>
<li>kibot <a href="https://github.com/skorokithakis/KiBot">https://github.com/skorokithakis/KiBot</a></li>
<li>kiauto <a href="https://github.com/INTI-CMNB/KiAuto">https://github.com/INTI-CMNB/KiAuto</a></li>
<li>openscad</li>
</ul>
<h2 id="windows">Windows</h2>
<ul>
<li>rc</li>
</ul>
<h2 id="building-on-linux">Building on Linux</h2>
<h2 id="building-on-windows">Building on Windows</h2>
<h2 id="building-on-os-x">Building on OS X</h2>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-b4fc2470f5b73f0193cb157a62cdca4d">5.3 - Building Hardware</h1>
    
	<p>For PCB design we use <a href="https://www.kicad.org/">kicad</a> and to automate the generation of gerber and outline files we use <a href="https://github.com/INTI-CMNB/KiBot">kibot</a>.</p>
<p>For designing 3D base board adapters we use <a href="https://openscad.org/">openscad</a></p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4cc88fdb1fbf7b9a580dd4f140bc4add">6 - Licenses</h1>
    
	<h1 id="applicable-licenses">Applicable Licenses</h1>
<p>The code in this repository builds upon the contributions of a number of other projects.   Unless otherwise stated, or unless other license terms dominate, the software developed for this project is distributed under
a <a href="../../software_license">BSD 3-clause license</a>.</p>
<p>For example, the Qt based applications were developed using the Qt GPL terms, therefore those applications honor the terms of that licence.  In contrast, the command-line applications rely on libraries whose license terms that do not take precedence over the project license.</p>
<p><strong>A Request</strong></p>
<p>We request that any use of this work or derivatives of this work in scientific research appropriately cite our contributions in any publications.</p>
<p>how to cite:</p>
<h2 id="1-host-software">1. Host Software</h2>
<p>We consider the host software in three categories &ndash; the tag and monitor libraries,  and the various applications.   The tag/monitor libraries build upon libraries that are compatible with our project license.</p>
<h3 id="11-tagmonitor-libraries">1.1 Tag/Monitor Libraries</h3>
<p>The monitor library provides connectivity, via USB, to the baseboard which emulates an stlink device.  The monitor library utilizes libusb which is
licensed under the <a href="../../lgpl2_1.txt">lesser gpl 2 licence</a>.  In addition, the monitor library code utilizes constants and ideas from stlink-org which is licensed under a <a href="../../stlink-org-license.md">BSD 3-clause licence</a>.</p>
<p>The tag library uses code built with the Google ProtoBuf compiler and linked to the Google ProtoBuf libraries that code is licensed under a <a href="../../protobuf-license.txt">Google License</a>.</p>
<h3 id="12--command-line-applications">1.2  Command-line Applications</h3>
<p>The command-line applications use the monitor and tag libraries; any other code is licensed under the default terms described above.</p>
<h3 id="13-qt-based-applications">1.3 Qt Based Applications</h3>
<p>The two Qt based applications were developed under the Qt open source license terms and hence the use of Qt libraries is covered by the <a href="../../lgplv3.txt">LGPLv3</a> license.  ** how to get QT source code **</p>
<p>The BitTag data visualization application (btviz) uses the QCustomPlot library and hence is licensed under <a href="https://www.gnu.org/licenses/gpl-3.0.html">GPLv3</a>.  The creator of <a href="https://www.qcustomplot.com/">QCustomPlot</a> offers commercial licenses.  In this case, the Qt open source license terms apply to the use of Qt libraries, and our project license applies to the remaining source code.</p>
<h2 id="2-embedded-software">2. Embedded Software</h2>
<h3 id="21-base-boards">2.1 Base Boards</h3>
<h3 id="22-tags">2.2 Tags</h3>
<h2 id="3-hardware">3. Hardware</h2>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-090b524d68b6b82d910e768d01f514b7">7 - Acknowledgement</h1>
    <div class="lead">Acknowledgements for funding and research contributions</div>
	<p>This material is based upon work supported by the National Science Foundation Grant Number 1644717.  Any opinions, findings, and conclusions or recommendations expressed in this material are those of the author(s) and do not necessarily reflect the views of the National Science Foundation.</p>

</div>



    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-dfd91cba8922c58885adc6e41750dfde">8 - Contacts</h1>
    
	<h1 id="contact-information">Contact Information</h1>
<p>Geoffrey Brown
<a href="mailto:geobrown@indiana.edu">geobrown@indiana.edu</a></p>

</div>



    
	
  



          </main>
        </div>
      </div>
      
<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid mx-sm-5">
    <div class="row">
      <div class="col-6 col-sm-4 text-xs-center order-sm-2">
        
        
        
      </div>
      <div class="col-6 col-sm-4 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/google/docsy" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-12 col-sm-4 text-center py-2 order-sm-2">
        <small class="text-white">&copy; 2022 Geoffrey Brown All Rights Reserved</small>
        
	
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js" integrity="sha384-+YQ4JLhjyBLPDQt//I+STsc9iw4uQqACwlvpslubQzn4u2UU2UFM80nGisd026JF" crossorigin="anonymous"></script>


<script src="https://cdn.jsdelivr.net/npm/mermaid@8.11.2/dist/mermaid.min.js" integrity="sha384-m8Pdaep6Qk8sW3J6XhPOiwUww3maU9HxZTLvEfSEB4e1UVvTdHyfJsYmEfYqvwLC" crossorigin="anonymous"></script>




<script src='../../js/tabpane-persist.js'></script>




 

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/katex.min.css" integrity="sha384-Cqd8ihRLum0CCg8rz0hYKPoLZ3uw+gES2rXQXycqnL5pgVQIflxAUDS7ZSjITLb5" crossorigin="anonymous">

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/katex.min.js" integrity="sha384-1Or6BdeNQb0ezrmtGeqQHFpppNd7a/gw29xeiSikBbsb44xu3uAo8c7FwbF5jhbd" crossorigin="anonymous"></script>
 


<script defer src='https://cdn.jsdelivr.net/npm/katex@0.13.2/dist/contrib/auto-render.min.js' integrity='sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl' crossorigin='anonymous' onload='renderMathInElement(document.body, {"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"},{"display":true,"left":"\\[","right":"\\\\]"}]});'></script>














<script src="../../js/main.min.a558dfc930f89b04cfee47eebf104ce100ee260e60b8e1a14a4b6a7b1f1025a1.js" integrity="sha256-pVjfyTD4mwTP7kfuvxBM4QDuJg5guOGhSktqex8QJaE=" crossorigin="anonymous"></script>




  </body>
</html>
